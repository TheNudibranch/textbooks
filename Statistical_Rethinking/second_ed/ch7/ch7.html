<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Rethinking - Chapter 7</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="ch7_files/libs/clipboard/clipboard.min.js"></script>
<script src="ch7_files/libs/quarto-html/quarto.js"></script>
<script src="ch7_files/libs/quarto-html/popper.min.js"></script>
<script src="ch7_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="ch7_files/libs/quarto-html/anchor.min.js"></script>
<link href="ch7_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="ch7_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="ch7_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="ch7_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="ch7_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#section" id="toc-section" class="nav-link active" data-scroll-target="#section">7.0</a></li>
  <li><a href="#problems-with-parameters" id="toc-problems-with-parameters" class="nav-link" data-scroll-target="#problems-with-parameters">7.1 - Problems with parameters</a></li>
  <li><a href="#entropy-and-accuracy" id="toc-entropy-and-accuracy" class="nav-link" data-scroll-target="#entropy-and-accuracy">7.2 - Entropy and accuracy</a></li>
  <li><a href="#golem-taming-regularization" id="toc-golem-taming-regularization" class="nav-link" data-scroll-target="#golem-taming-regularization">7.3 - Golem taming: regularization</a></li>
  <li><a href="#predicting-predictive-accuracy" id="toc-predicting-predictive-accuracy" class="nav-link" data-scroll-target="#predicting-predictive-accuracy">7.4 - Predicting predictive accuracy</a></li>
  <li><a href="#model-comparison" id="toc-model-comparison" class="nav-link" data-scroll-target="#model-comparison">7.5 - Model Comparison</a></li>
  <li><a href="#exercises" id="toc-exercises" class="nav-link" data-scroll-target="#exercises">Exercises</a>
  <ul class="collapse">
  <li><a href="#m.1" id="toc-m.1" class="nav-link" data-scroll-target="#m.1">M.1</a></li>
  <li><a href="#m.3" id="toc-m.3" class="nav-link" data-scroll-target="#m.3">M.3</a></li>
  <li><a href="#h.1" id="toc-h.1" class="nav-link" data-scroll-target="#h.1">H.1</a></li>
  <li><a href="#h.2" id="toc-h.2" class="nav-link" data-scroll-target="#h.2">H.2</a></li>
  <li><a href="#h.3" id="toc-h.3" class="nav-link" data-scroll-target="#h.3">H.3</a></li>
  </ul></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Rethinking - Chapter 7</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rethinking)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dagitty)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="section" class="level2">
<h2 class="anchored" data-anchor-id="section">7.0</h2>
<ul>
<li>We are worried about
<ul>
<li>Overfitting</li>
<li>Underfitting</li>
<li>Confounding</li>
</ul></li>
<li>We will see that confounding, while incorrect, can produce more <em>accurate</em> models than if we had removed the confounding variable
<ul>
<li>Most accurate is not synonymous with causally correct</li>
<li>We must ask if we want to understand causes, or just predict</li>
</ul></li>
<li><strong>regularizing prior</strong>: tell the model to not get too excited about new data</li>
<li>predictor variables that improve prediction are not always statistically significant
<ul>
<li>The inverse can be true as well - stat sig variables that don’t help prediction</li>
<li>They are two different tasks</li>
</ul></li>
<li>AIC uses MAP estimates instead of the entire posterior
<ul>
<li>It also requires flat priors</li>
</ul></li>
<li>The BIC is not actually an “information criterion”</li>
<li>WAIC can provide the same results as AIC when assumptions are met
<ul>
<li>AIC is therefore a special case of WAIC - a purely Bayesian information criteria</li>
</ul></li>
</ul>
</section>
<section id="problems-with-parameters" class="level2">
<h2 class="anchored" data-anchor-id="problems-with-parameters">7.1 - Problems with parameters</h2>
<p>Introduce <span class="math inline">\(R^2\)</span>:</p>
<p><span class="math display">\[R^2 = \frac{\text{var(outcome) - var(residuals)}}{\text{var(outcome)}} = 1 - \frac{\text{var(residuals)}}{\text{var(outcome)}}\]</span> The <span class="math inline">\(R^2\)</span> will also increase the more predictors we add, even when the variables added are just random noise.</p>
<ul>
<li>Regular features: target features because they generalize well</li>
</ul>
<p>Let’s look at a dataset of average brain volumes and body mass</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>sppnames <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'afarensis'</span>, <span class="st">'africanus'</span>, <span class="st">'habilis'</span>, <span class="st">'boisei'</span>, <span class="st">'rudolfensis'</span>, <span class="st">'ergaster'</span>, <span class="st">'sapiens'</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>brainvolcc <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">438</span>, <span class="dv">452</span>, <span class="dv">612</span>, <span class="dv">521</span>, <span class="dv">752</span>, <span class="dv">871</span>, <span class="dv">1350</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>masskg <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">37</span>, <span class="fl">35.5</span>, <span class="fl">34.5</span>, <span class="fl">41.5</span>, <span class="fl">55.5</span>, <span class="dv">61</span>, <span class="fl">53.5</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">species=</span>sppnames, <span class="at">brain=</span>brainvolcc, <span class="at">mass=</span>masskg)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Let’s rescale and center body mass. We will just rescale brain to be between 0 and 1 since we want to keep the zero reference point. We’ll also build a simple linear model.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>d<span class="sc">$</span>mass_std <span class="ot">&lt;-</span> <span class="fu">standardize</span>(d<span class="sc">$</span>mass)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>d<span class="sc">$</span>brain_std <span class="ot">&lt;-</span> d<span class="sc">$</span>brain <span class="sc">/</span> <span class="fu">max</span>(d<span class="sc">$</span>brain)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The simple linear model as absurd priors, but that is part of the lesson:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>m7<span class="fl">.1</span> <span class="ot">&lt;-</span> <span class="fu">quap</span>(<span class="fu">alist</span>(</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  brain_std <span class="sc">~</span> <span class="fu">dnorm</span>(mu, <span class="fu">exp</span>(log_sigma)),</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> a <span class="sc">+</span> b<span class="sc">*</span>mass_std,</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  a <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="fl">0.5</span>, <span class="dv">1</span>),</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  b <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>, <span class="dv">10</span>),</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  log_sigma <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="dv">1</span>) <span class="co"># Bakes out the same as log normal</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>), <span class="at">data=</span>d)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Just as an aside, you can extract samples from a simple OLS model, since OLS is really just an approximate bayes algorithm with flat priors. You won’t get a sigma posterior though</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>m7<span class="fl">.1</span>_OLS <span class="ot">&lt;-</span> <span class="fu">lm</span>(brain_std <span class="sc">~</span> mass_std, <span class="at">data=</span>d)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>post <span class="ot">&lt;-</span> <span class="fu">extract.samples</span>(m7<span class="fl">.1</span>_OLS)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Let’s calculate <span class="math inline">\(R^2\)</span> for this model. Here we actually want the average squared deviation since we are in a Bayesian context. We don’t want the <span class="math inline">\(n-1\)</span> correction term. This is implemented in Richie’s <code>var2</code> function</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>var2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>function (x, na.rm = TRUE) 
{
    mean(x^2) - mean(x)^2
}
&lt;bytecode: 0x00000199eeb4d978&gt;
&lt;environment: namespace:rethinking&gt;</code></pre>
</div>
</div>
<p>Alright, let’s compute:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>R2_is_bad <span class="ot">&lt;-</span> <span class="cf">function</span>(quap_fit){</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  s <span class="ot">&lt;-</span> <span class="fu">sim</span>(quap_fit)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  r <span class="ot">&lt;-</span> <span class="fu">colMeans</span>(s) <span class="sc">-</span> d<span class="sc">$</span>brain_std</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  resid_var <span class="ot">&lt;-</span> <span class="fu">var2</span>(r)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  outcome_var <span class="ot">&lt;-</span> <span class="fu">var2</span>(d<span class="sc">$</span>brain_std)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span> <span class="sc">-</span> resid_var<span class="sc">/</span>outcome_var  </span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="fu">R2_is_bad</span>(m7<span class="fl">.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.4774589</code></pre>
</div>
</div>
<p>Alright, let’s go crazy with polynomials:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>m7<span class="fl">.2</span> <span class="ot">&lt;-</span> <span class="fu">quap</span>(<span class="fu">alist</span>(</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  brain_std <span class="sc">~</span> <span class="fu">dnorm</span>(mu, <span class="fu">exp</span>(log_sigma)),</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> a <span class="sc">+</span> b[<span class="dv">1</span>]<span class="sc">*</span>mass_std <span class="sc">+</span> b[<span class="dv">2</span>]<span class="sc">*</span>mass_std<span class="sc">^</span><span class="dv">2</span>,</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  a <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="fl">0.5</span>, <span class="dv">1</span>),</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  b <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>, <span class="dv">10</span>),</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  log_sigma <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="dv">1</span>) <span class="co"># Bakes out the same as log normal</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>), <span class="at">data=</span>d, <span class="at">start=</span><span class="fu">list</span>(<span class="at">b=</span><span class="fu">rep</span>(<span class="dv">0</span>,<span class="dv">2</span>)))</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>m7<span class="fl">.3</span> <span class="ot">&lt;-</span> <span class="fu">quap</span>(<span class="fu">alist</span>(</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  brain_std <span class="sc">~</span> <span class="fu">dnorm</span>(mu, <span class="fu">exp</span>(log_sigma)),</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> a <span class="sc">+</span> b[<span class="dv">1</span>]<span class="sc">*</span>mass_std <span class="sc">+</span> b[<span class="dv">2</span>]<span class="sc">*</span>mass_std<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> b[<span class="dv">3</span>]<span class="sc">*</span>mass_std<span class="sc">^</span><span class="dv">3</span>,</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>  a <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="fl">0.5</span>, <span class="dv">1</span>),</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>  b <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>, <span class="dv">10</span>),</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>  log_sigma <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="dv">1</span>) <span class="co"># Bakes out the same as log normal</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>), <span class="at">data=</span>d, <span class="at">start=</span><span class="fu">list</span>(<span class="at">b=</span><span class="fu">rep</span>(<span class="dv">0</span>,<span class="dv">3</span>)))</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>m7<span class="fl">.4</span> <span class="ot">&lt;-</span> <span class="fu">quap</span>(<span class="fu">alist</span>(</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>  brain_std <span class="sc">~</span> <span class="fu">dnorm</span>(mu, <span class="fu">exp</span>(log_sigma)),</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> a <span class="sc">+</span> b[<span class="dv">1</span>]<span class="sc">*</span>mass_std <span class="sc">+</span> b[<span class="dv">2</span>]<span class="sc">*</span>mass_std<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> b[<span class="dv">3</span>]<span class="sc">*</span>mass_std<span class="sc">^</span><span class="dv">3</span> <span class="sc">+</span> b[<span class="dv">4</span>]<span class="sc">*</span>mass_std<span class="sc">^</span><span class="dv">4</span>,</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>  a <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="fl">0.5</span>, <span class="dv">1</span>),</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>  b <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>, <span class="dv">10</span>),</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>  log_sigma <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="dv">1</span>) <span class="co"># Bakes out the same as log normal</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>), <span class="at">data=</span>d, <span class="at">start=</span><span class="fu">list</span>(<span class="at">b=</span><span class="fu">rep</span>(<span class="dv">0</span>,<span class="dv">4</span>)))</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>m7<span class="fl">.5</span> <span class="ot">&lt;-</span> <span class="fu">quap</span>(<span class="fu">alist</span>(</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>  brain_std <span class="sc">~</span> <span class="fu">dnorm</span>(mu, <span class="fu">exp</span>(log_sigma)),</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> a <span class="sc">+</span> b[<span class="dv">1</span>]<span class="sc">*</span>mass_std <span class="sc">+</span> b[<span class="dv">2</span>]<span class="sc">*</span>mass_std<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> b[<span class="dv">3</span>]<span class="sc">*</span>mass_std<span class="sc">^</span><span class="dv">3</span> <span class="sc">+</span> b[<span class="dv">4</span>]<span class="sc">*</span>mass_std<span class="sc">^</span><span class="dv">4</span> <span class="sc">+</span> b[<span class="dv">5</span>]<span class="sc">*</span>mass_std<span class="sc">^</span><span class="dv">5</span>,</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>  a <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="fl">0.5</span>, <span class="dv">1</span>),</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>  b <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>, <span class="dv">10</span>),</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>  log_sigma <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="dv">1</span>) <span class="co"># Bakes out the same as log normal</span></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>), <span class="at">data=</span>d, <span class="at">start=</span><span class="fu">list</span>(<span class="at">b=</span><span class="fu">rep</span>(<span class="dv">0</span>,<span class="dv">5</span>)))</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>m7<span class="fl">.6</span> <span class="ot">&lt;-</span> <span class="fu">quap</span>(<span class="fu">alist</span>(</span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>  brain_std <span class="sc">~</span> <span class="fu">dnorm</span>(mu, <span class="fl">0.001</span>),</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> a <span class="sc">+</span> b[<span class="dv">1</span>]<span class="sc">*</span>mass_std <span class="sc">+</span> b[<span class="dv">2</span>]<span class="sc">*</span>mass_std<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> b[<span class="dv">3</span>]<span class="sc">*</span>mass_std<span class="sc">^</span><span class="dv">3</span> <span class="sc">+</span> b[<span class="dv">4</span>]<span class="sc">*</span>mass_std<span class="sc">^</span><span class="dv">4</span> <span class="sc">+</span> b[<span class="dv">5</span>]<span class="sc">*</span>mass_std<span class="sc">^</span><span class="dv">5</span> <span class="sc">+</span> b[<span class="dv">5</span>]<span class="sc">*</span>mass_std<span class="sc">^</span><span class="dv">6</span>,</span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>  a <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="fl">0.5</span>, <span class="dv">1</span>),</span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>  b <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>, <span class="dv">10</span>)</span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>), <span class="at">data=</span>d, <span class="at">start=</span><span class="fu">list</span>(<span class="at">b=</span><span class="fu">rep</span>(<span class="dv">0</span>,<span class="dv">5</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The last model <code>m7.6</code> has its variance replace with 0.001. I’m guessing this is because if we didn’t hard code it we would have 8 parameters for 7 points of data.</p>
<p>Let’s go ahead and plot these:</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>plot_func <span class="ot">&lt;-</span> <span class="cf">function</span>(quap_fit, name){</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  post <span class="ot">&lt;-</span> <span class="fu">extract.samples</span>(quap_fit)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  mass_seq <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fu">min</span>(d<span class="sc">$</span>mass_std), <span class="fu">max</span>(d<span class="sc">$</span>mass_std), <span class="at">length.out=</span><span class="dv">100</span>)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  l <span class="ot">&lt;-</span> <span class="fu">link</span>(quap_fit, <span class="at">data=</span><span class="fu">list</span>(<span class="at">mass_std=</span>mass_seq))</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> <span class="fu">colMeans</span>(l)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  ci <span class="ot">&lt;-</span> <span class="fu">apply</span>(l, <span class="dv">2</span>, PI)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(brain_std <span class="sc">~</span> mass_std, <span class="at">data=</span>d, <span class="at">main=</span><span class="fu">paste0</span>(<span class="st">'Model '</span>, name, <span class="st">'R^2='</span>, <span class="fu">round</span>(<span class="fu">R2_is_bad</span>(quap_fit), <span class="dv">2</span>)), <span class="at">ylim=</span><span class="fu">c</span>(<span class="fu">range</span>(ci, mu, d<span class="sc">$</span>brain_std)))</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(mass_seq, mu)</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">shade</span>(ci, mass_seq)</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">3</span>))</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>) <span class="fu">paste0</span>(<span class="st">'plot_func(m7.'</span>, i,<span class="st">','</span>,i, <span class="st">')'</span>) <span class="sc">|&gt;</span> <span class="fu">parse</span>(<span class="at">text=</span>_) <span class="sc">|&gt;</span> <span class="fu">eval</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ch7_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
<p>Notice that the model predicts negative brain size for <code>m7.6</code>, not great. Model <code>m7.1</code> could be said to be underfit. This means that it is not sensitive to changes in the sample. If we removed a point, it would probably look relatively the same. Alternatively, model <code>m7.4</code> is overfit. If we remove a point, the polynomial mean line would look wildly different.</p>
<p>Bias-variance: bias (underfitting) and variance (overfitting).</p>
</section>
<section id="entropy-and-accuracy" class="level2">
<h2 class="anchored" data-anchor-id="entropy-and-accuracy">7.2 - Entropy and accuracy</h2>
<p>We need to:</p>
<ul>
<li>Establish a measurement scale for distance from perfect accuracy</li>
<li>Need to measure <em>deviance</em> as an approximation of relative distance from perfect accuracy</li>
<li>Establish that it is <em>deviance</em> out-of-sample that is only of interest</li>
</ul>
<p>To define a target, there are two main dimensions to worry about:</p>
<ul>
<li>cost-benefit analysis</li>
<li>Accuracy in context</li>
</ul>
<p>Joint probability is the measure we want. It’s the unique measure that correctly counts up the relative number of ways each event could happen. The true model will also have the highest joint probability.</p>
<p><strong>Information:</strong> The reduction in uncertainty when we learn an outcome.</p>
<p>What is a good measure of uncertainty:</p>
<ul>
<li>A measure of uncertainty should be continuous</li>
<li>The measure should increase as the number of possible events increases</li>
<li>Measures should be additive.</li>
</ul>
<p>The function that satisfies these desiderata has one form and is called <strong>information entropy</strong>. For <span class="math inline">\(n\)</span> possible events, with each event <span class="math inline">\(i\)</span> occurring with probability <span class="math inline">\(p_i\)</span>, then the entropy is:</p>
<p><span class="math display">\[H(p)=-E_p[\log(p_i)]=-\sum^n_{i=1}p_i\log(p_i)\]</span></p>
<p>We can use entropy to build measures of accuracy. Also, when <span class="math inline">\(p_i=0\)</span>, we can use L’Hopitals rule to show <span class="math inline">\(p_i\log(p_i)=0\)</span>. Notice, also that maximizing entropy is the same as decreasing uncertainty.</p>
<p><strong>Divergence:</strong> The additional uncertainty induced by using probabilites from one distribution to describe anoter distribution.</p>
<p>The KL divergence is defined as:</p>
<p><span class="math display">\[D_{\text{KL}}(p,q)=\sum_i p_i \log(p_i/q_i)\]</span></p>
<p>In plain english: the average difference in log probability between the target <span class="math inline">\(p\)</span> and model <span class="math inline">\(q\)</span>. This is also just the difference between two entropies: the entropy of the target distribution <span class="math inline">\(p\)</span> and the <em>cross entropy</em> arising from using <span class="math inline">\(q\)</span> to predict <span class="math inline">\(p\)</span>. We can use this metric to predict different models.</p>
<p>One thing to callout here is the definition of cross entropy:</p>
<p><span class="math display">\[H(p,q)=-E\log(p_i)=-\sum^n_{i=1}p_i\log(q_i)\]</span> This is really just the expected value of <span class="math inline">\(\log(q)\)</span> with respect to <span class="math inline">\(p\)</span>. This also shows why KL Divergence is not symmetric - you are changing the reference distribution for the cross entropy.</p>
<p>Notice that we almost never have <span class="math inline">\(p\)</span>, the true distribution. But, we have some estimates <span class="math inline">\(q\)</span> and <span class="math inline">\(r\)</span>, we can compare these two since <span class="math inline">\(p\)</span> will drop out in the comparison. It is convention to just take the sum of the log-probabilities. There is a convenient function to do just this:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">lppd</span>(m7<span class="fl">.1</span>,<span class="at">n=</span><span class="fl">1e4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1]  0.6098715  0.6483484  0.5496111  0.6234979  0.4648178  0.4347639 -0.8444734</code></pre>
</div>
</div>
<p>If you summed the above, you’d get the log-probability score. Larger values are better since they indicate larger average accuracy. It is common to see this called deviance, but multiplied by -2. the -2 is for historical reasons and is really done so the sample distribution falls more in line with a Chi-squared distribution.</p>
<p>The <code>lppd</code> function shown above is called the <strong>log-pointwise-predictive-density</strong> as is defined as:</p>
<p><span class="math display">\[\text{lppd}(y,\Theta)=\sum_i \log\frac{1}{S}\sum_s p(y_i|\Theta_s)\]</span></p>
<p>Where <span class="math inline">\(S\)</span> is the number of samples and <span class="math inline">\(\Theta_s\)</span> is the s-th sampled parameter vector from the posterior.</p>
<p>Here is the code to do just that:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>logprob <span class="ot">&lt;-</span> <span class="fu">sim</span>(m7<span class="fl">.1</span>, <span class="at">ll=</span>T, <span class="at">n=</span><span class="fl">1e4</span>) <span class="co"># Same function used in ch4, will return </span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># a matrix of log-probability values of ll=T</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>ns <span class="ot">&lt;-</span> <span class="fu">nrow</span>(logprob)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">ncol</span>(logprob)</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> \(x) <span class="fu">log_sum_exp</span>(logprob[,x]) <span class="sc">-</span> <span class="fu">log</span>(ns)</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="fu">vapply</span>(<span class="dv">1</span><span class="sc">:</span>n, f, <span class="fu">numeric</span>(<span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1]  0.6098715  0.6483484  0.5496111  0.6234979  0.4648178  0.4347639 -0.8444734</code></pre>
</div>
</div>
<p>We are still going to suffer from the same issue that the <span class="math inline">\(R^2\)</span> had: the scores will get better as the model becomes more complex.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="fu">vapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>, \(x){</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste0</span>(<span class="st">'lppd(m7.'</span>,x,<span class="st">') |&gt; sum()'</span>) <span class="sc">|&gt;</span> <span class="fu">parse</span>(<span class="at">text=</span>_) <span class="sc">|&gt;</span> <span class="fu">eval</span>()</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>}, <span class="fu">numeric</span>(<span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1]    2.490403    2.566165    3.741488    5.333750   14.095009 -606.485083</code></pre>
</div>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>logprob <span class="ot">&lt;-</span> <span class="fu">sim</span>(m7<span class="fl">.6</span>, <span class="at">ll=</span>T, <span class="at">n=</span><span class="fl">1e4</span>) <span class="co"># Same function used in ch4, will return </span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># a matrix of log-probability values of ll=T</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>ns <span class="ot">&lt;-</span> <span class="fu">nrow</span>(logprob)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">ncol</span>(logprob)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> \(x) <span class="fu">log_sum_exp</span>(logprob[,x]) <span class="sc">-</span> <span class="fu">log</span>(ns)</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="fu">vapply</span>(<span class="dv">1</span><span class="sc">:</span>n, f, <span class="fu">numeric</span>(<span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -136.261379 -420.150617  -58.781680    3.429006    5.640072    5.642777
[7]    5.609147</code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">precis</span>(m7<span class="fl">.6</span>, <span class="at">depth=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>           mean          sd       5.5%      94.5%
b[1]  1.4127005 0.003221105  1.4075525  1.4178484
b[2]  0.1664465 0.006733439  0.1556852  0.1772079
b[3] -2.0448680 0.005812292 -2.0541572 -2.0355788
b[4] -1.1757658 0.008049811 -1.1886310 -1.1629007
b[5]  0.5812014 0.002336917  0.5774666  0.5849363
a     0.8075114 0.001780075  0.8046665  0.8103563</code></pre>
</div>
</div>
<p>Let’s simulate some training and testing datasets and see how deviance changes (both in and out of sample) with the number of free parameters:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># To save time I'm only going to do 100 replications</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="do">### Takes too long to run, but you get the gist</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">20</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>kseq <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>dev <span class="ot">&lt;-</span> <span class="fu">vapply</span>(kseq, \(x) {</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  r <span class="ot">&lt;-</span> <span class="fu">replicate</span>(<span class="dv">5</span>, <span class="fu">sim_train_test</span>(N,x))</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="fu">mean</span>(r[<span class="dv">1</span>,]), <span class="fu">mean</span>(r[<span class="dv">2</span>,]), <span class="fu">sd</span>(r[<span class="dv">1</span>,]), <span class="fu">sd</span>(r[<span class="dv">2</span>,]))</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>}, <span class="fu">numeric</span>(<span class="dv">4</span>))</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, dev[<span class="dv">1</span>,], <span class="at">ylim=</span><span class="fu">c</span>(<span class="fu">min</span>(dev[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>,])<span class="sc">-</span><span class="dv">5</span>, <span class="fu">max</span>(dev[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>,])<span class="sc">+</span><span class="dv">10</span>), <span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="fl">5.1</span>))</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, dev[<span class="dv">2</span>,], <span class="at">col=</span><span class="st">'darkblue'</span>, <span class="at">pch=</span><span class="dv">16</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="golem-taming-regularization" class="level2">
<h2 class="anchored" data-anchor-id="golem-taming-regularization">7.3 - Golem taming: regularization</h2>
<ul>
<li>Quick intro to regularization</li>
<li>Multilevel models allow the model to choose how much regularization they need</li>
<li>Regularization doesn’t matter much in the case of larger sample sizes</li>
<li>Equivalent to ridge regression in classical statistics</li>
</ul>
</section>
<section id="predicting-predictive-accuracy" class="level2">
<h2 class="anchored" data-anchor-id="predicting-predictive-accuracy">7.4 - Predicting predictive accuracy</h2>
<p>Time to start using PSIS-LOOCV: pareto smoothed importance sampling for leave-one-out cross-validation. Let’s say that we have a model, and we choose to fit it <span class="math inline">\(N\)</span> times, leaving out <span class="math inline">\(y_i\)</span> everytime we fit. Then the out-of-sample <strong>log-pointwise predictive density</strong> is given by</p>
<p><span class="math display">\[\text{lppd}_{\text{CV}} = \sum_{i=1}^N \frac{1}{S} \sum^S_{i=1} \log P(y_i|\theta_{-i,s})\]</span></p>
<p>where <span class="math inline">\(\theta_{-i,s}\)</span> is the <span class="math inline">\(s\)</span>-th sample from the markov chain, approximating the posterior for when we left <span class="math inline">\(y_i\)</span> out of inference.</p>
<p>This is cool, but it is expensive. A better approach is to weight each observation by its importance to the posterior and using that weight in conjunction with the posterior from the entire dataset to get an estimate of <span class="math inline">\(\text{lppd}_{\text{CV}}\)</span>. For the weights we will use:</p>
<p><span class="math display">\[r(\theta_s)=\frac{1}{p(y_i|\theta_s)}\]</span></p>
<p>This then allows us to get:</p>
<p><span class="math display">\[\text{lppd}_{\text{IS}} = \sum_{i=1}^N\log\frac{\sum^S_{s=1} r(\theta_s) p(y_i|s)}{\sum^S_{s=1} r(\theta_s)}\]</span></p>
<p>Where we divide by the importance ratios do get a normalized estimate. The Pareto piece comes in when we need to smooth out <span class="math inline">\(r(\theta_s)\)</span>. For influential observations, the rations will have very heavy tails. The Parteo distribution helps us smooth this out, as well as giving us a nice diagnostic parameter <span class="math inline">\(k\)</span> from the Pareto distribution fit to the importance rations for each point. If <span class="math inline">\(k &lt; 0.7\)</span> we have a good estimate and don’t need to worry about our approximation (as much).</p>
<p>Let’s go back to information criteria. Bet you didn’t notice that when we looked at the difference between train and test deviance’s by # of params., the distance between train and test was twice the number of parameters? This is actually one of the cool things that falls out of the theory. The OLS, the expected overfitting penalty is about twice the number of parameters.</p>
<p>We can use this fact to get the AIC (Akaike Information Criteria):</p>
<p><span class="math display">\[\text{AIC} = D_{\text{Train}} + 2p = -2\text{lppd} + 2p\]</span></p>
<p>where <span class="math inline">\(p\)</span> is the number of free parameters. AIC is mostly defunct now as it relies on some strong assumptions:</p>
<ul>
<li>The priors are flat or overwhelmed by the likelihood</li>
<li>The posterior distribution is approx. multivariate Gaussian</li>
<li>The sample size <span class="math inline">\(N\)</span> is much greater than the number of parameters</li>
</ul>
<p>The DIC is a more general metric that is okay with informative priors, but still requires that <span class="math inline">\(N \gg k\)</span>.</p>
<p>We’ll focus on WAIC which does not make any assumptions about the shape of the posterior and converges to the leave-one-out approximation in large samples. It is really just the log-posterior-predictive-density we calculated earlier but with a penalty term proportional to the variance in the posterior predictions. It’s goal is to approximate the out-of-sample KL divergence:</p>
<p><span class="math display">\[\text{WAIC}(y,\Theta)=-2 (\text{lppd} - \sum_i\text{var}_{\theta}\log p(y_i|\theta))\]</span></p>
<p>The penalty term (the sum) is sometimes called the “effective number of parameters” <span class="math inline">\(p_{\text{WAIC}}\)</span>. Richie will call this the “overfitting penalty”.</p>
<p>Let’s walk through a WAIC calculation:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(cars)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">quap</span>(<span class="fu">alist</span>(</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  dist <span class="sc">~</span> <span class="fu">dnorm</span>(mu, sigma),</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> a <span class="sc">+</span> b<span class="sc">*</span>speed,</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  a <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="dv">100</span>),</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  b <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="dv">10</span>),</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>  sigma <span class="sc">~</span> <span class="fu">dexp</span>(<span class="dv">1</span>)</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>), <span class="at">data=</span>cars)</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>post <span class="ot">&lt;-</span> <span class="fu">extract.samples</span>(m,<span class="at">n=</span><span class="fl">1e3</span>)</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>n_samples <span class="ot">&lt;-</span> <span class="fu">nrow</span>(post)</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>logprob <span class="ot">&lt;-</span> <span class="fu">vapply</span>(<span class="dv">1</span><span class="sc">:</span>n_samples, \(s){</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> post<span class="sc">$</span>a[s] <span class="sc">+</span> post<span class="sc">$</span>b[s]<span class="sc">*</span>cars<span class="sc">$</span>speed</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dnorm</span>(cars<span class="sc">$</span>dist, mu, post<span class="sc">$</span>sigma[s], <span class="at">log=</span>T)</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>}, <span class="fu">numeric</span>(<span class="fu">nrow</span>(cars)))</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>lppd <span class="ot">&lt;-</span> <span class="fu">vapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(cars), \(x) <span class="fu">log_sum_exp</span>(logprob[x,]) <span class="sc">-</span> <span class="fu">log</span>(n_samples), <span class="fu">numeric</span>(<span class="dv">1</span>))</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Penalty term</span></span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>pWAIC <span class="ot">&lt;-</span> <span class="fu">vapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(cars), \(x) <span class="fu">var</span>(logprob[x,]), <span class="fu">numeric</span>(<span class="dv">1</span>))</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a><span class="sc">-</span><span class="dv">2</span><span class="sc">*</span>(<span class="fu">sum</span>(lppd) <span class="sc">-</span> <span class="fu">sum</span>(pWAIC))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 423.2869</code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">WAIC</span>(m) <span class="co"># Get pointwise by setting `pointwise=T`</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>      WAIC      lppd penalty  std_err
1 423.0496 -206.8991 4.62574 17.58396</code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>waic_vec <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">2</span><span class="sc">*</span>(lppd <span class="sc">-</span> pWAIC)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="co"># std. error on WAIC</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="fu">sqrt</span>(<span class="fu">nrow</span>(cars)<span class="sc">*</span><span class="fu">var</span>(waic_vec))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 17.88919</code></pre>
</div>
</div>
<p>Notice that we can approximate the standard error by assuming that each WAIC in the <code>waic_vec</code> came from a the same distribution, so the variance of the sum of the vector (essentially the mean times a constant, invoking the central limit theorem) is the variance of the distribution they came from times the number of samples.</p>
</section>
<section id="model-comparison" class="level2">
<h2 class="anchored" data-anchor-id="model-comparison">7.5 - Model Comparison</h2>
<p>Let’s go back to chapter 6 where we built different causal models for inferring the effect of fungus on plant growth. Model <code>m6.6</code> just has the intercept, <code>m6.7</code> included both treatment and fungus, and <code>m6.8</code> is the model that includes treatment, but omits fungus (the correct one for the causal interpretation).</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">71</span>)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>h0 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,<span class="dv">10</span>,<span class="dv">2</span>)</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>treatment <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="at">each=</span>N<span class="sc">/</span><span class="dv">2</span>)</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>fungus <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(N, <span class="at">size=</span><span class="dv">1</span>, <span class="at">prob=</span><span class="fl">0.5</span> <span class="sc">-</span> treatment<span class="sc">*</span><span class="fl">0.4</span>)</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>h1 <span class="ot">&lt;-</span> h0 <span class="sc">+</span> <span class="fu">rnorm</span>(N, <span class="dv">5</span> <span class="sc">-</span> <span class="dv">3</span><span class="sc">*</span>fungus)</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(h0,h1,treatment, fungus)</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>m6<span class="fl">.6</span> <span class="ot">&lt;-</span> <span class="fu">quap</span>(<span class="fu">alist</span>(</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>  h1 <span class="sc">~</span> <span class="fu">dnorm</span>(mu, sigma),</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> h0<span class="sc">*</span>p,</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>  p <span class="sc">~</span> <span class="fu">dlnorm</span>(<span class="dv">0</span>,<span class="fl">0.25</span>),</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>  sigma <span class="sc">~</span> <span class="fu">dexp</span>(<span class="dv">1</span>)</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>), <span class="at">data=</span>d)</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>m6<span class="fl">.7</span> <span class="ot">&lt;-</span> <span class="fu">quap</span>(<span class="fu">alist</span>(</span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>  h1 <span class="sc">~</span> <span class="fu">dnorm</span>(mu, sigma),</span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> h0<span class="sc">*</span>p,</span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> a <span class="sc">+</span> bt<span class="sc">*</span>treatment <span class="sc">+</span> bf<span class="sc">*</span>fungus,</span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>  a <span class="sc">~</span> <span class="fu">dlnorm</span>(<span class="dv">0</span>,<span class="fl">0.2</span>),</span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>  bt <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="fl">0.5</span>),</span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>  bf <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="fl">0.5</span>),</span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>  sigma <span class="sc">~</span> <span class="fu">dexp</span>(<span class="dv">1</span>)</span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a>), <span class="at">data=</span>d)</span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a>m6<span class="fl">.8</span> <span class="ot">&lt;-</span> <span class="fu">quap</span>(<span class="fu">alist</span>(</span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a>  h1 <span class="sc">~</span> <span class="fu">dnorm</span>(mu, sigma),</span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> h0<span class="sc">*</span>p,</span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> a <span class="sc">+</span> bt<span class="sc">*</span>treatment,</span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a>  a <span class="sc">~</span> <span class="fu">dlnorm</span>(<span class="dv">0</span>,<span class="fl">0.2</span>),</span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a>  bt <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="fl">0.5</span>),</span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a>  sigma <span class="sc">~</span> <span class="fu">dexp</span>(<span class="dv">1</span>)</span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a>), <span class="at">data=</span>d)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Let’s check the WAIC to see which is better:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">compare</span>(m6<span class="fl">.6</span>, m6<span class="fl">.7</span>, m6<span class="fl">.8</span>, <span class="at">func=</span>WAIC) <span class="co"># Can also do func=PSIS</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>         WAIC       SE    dWAIC      dSE    pWAIC       weight
m6.7 361.8105 14.17580  0.00000       NA 3.785343 1.000000e+00
m6.8 403.0649 11.23902 41.25445 10.42699 2.791505 1.100805e-09
m6.6 406.2842 11.76437 44.47372 12.20547 1.752989 2.201174e-10</code></pre>
</div>
</div>
<p>First column is the WAIC (smaller is better). Notice how the variable with the fungus variable performed best. The <code>dWAIC</code> column is the distance from the model in question to the top (best) model. The <code>dSE</code> column is the standard error of the difference between models. Let’s do a quick calculation walkthrough:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>waic_m6<span class="fl">.7</span> <span class="ot">&lt;-</span> <span class="fu">WAIC</span>(m6<span class="fl">.7</span>, <span class="at">pointwise=</span>T)<span class="sc">$</span>WAIC</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>waic_m6<span class="fl">.8</span> <span class="ot">&lt;-</span> <span class="fu">WAIC</span>(m6<span class="fl">.8</span>, <span class="at">pointwise=</span>T)<span class="sc">$</span>WAIC</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">length</span>(waic_m6<span class="fl">.7</span>)</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>diff_m <span class="ot">&lt;-</span> waic_m6<span class="fl">.7</span> <span class="sc">-</span> waic_m6<span class="fl">.8</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="fu">sqrt</span>(n<span class="sc">*</span><span class="fu">var</span>(diff_m))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 10.28199</code></pre>
</div>
</div>
<p>Give the standard error, we know that the expected difference is quite far from zero (<span class="math inline">\(\mu \pm 2.6SE\)</span> assuming CLT kicked in).</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">compare</span>(m6<span class="fl">.6</span>, m6<span class="fl">.7</span>, m6<span class="fl">.8</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ch7_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
<p>The filled in points are the in-sample deviance (just the <span class="math inline">\(\text{lppd}\)</span> without the penalty term). The circle points (on the same line) are the WAIC values. The triangle point and line segments show the difference between the best model’s WAIC.</p>
<p>Let’s hone in on <code>m6.6</code> and <code>m6.8</code>. We can see their <code>dSE</code> slot in the returned S4 object.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">compare</span>(m6<span class="fl">.6</span>, m6<span class="fl">.7</span>, m6<span class="fl">.8</span>)<span class="sc">@</span>dSE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>          m6.6     m6.7      m6.8
m6.6        NA 12.17378  4.936713
m6.7 12.173782       NA 10.384196
m6.8  4.936713 10.38420        NA</code></pre>
</div>
</div>
<p>You notice that the standard error of the difference is bigger than the difference itself. Therefore we can not reliably say which model is better than the other.</p>
<p>You’ll notice that <code>weight</code> was in the comparison table. That is primarily used for model averaging. It is calculated as such:</p>
<p><span class="math display">\[w_i = \frac{\exp(-0.5\Delta_i)}{\sum_j\exp(-0.5\Delta_i)}\]</span></p>
<p>where <span class="math inline">\(\Delta_i\)</span> is the difference between model <span class="math inline">\(i\)</span>’s WAIC value and the best WAIC in the set.</p>
<p>Let’s now go back to chapter 5 and refit the divorce models:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(WaffleDivorce)</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> WaffleDivorce </span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>d<span class="sc">$</span>D <span class="ot">&lt;-</span> <span class="fu">standardize</span>(d<span class="sc">$</span>Divorce)</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>d<span class="sc">$</span>M <span class="ot">&lt;-</span> <span class="fu">standardize</span>(d<span class="sc">$</span>Marriage)</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>d<span class="sc">$</span>A <span class="ot">&lt;-</span> <span class="fu">standardize</span>(d<span class="sc">$</span>MedianAgeMarriage)</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>m5<span class="fl">.1</span> <span class="ot">&lt;-</span> <span class="fu">quap</span>(<span class="fu">alist</span>(</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>  D <span class="sc">~</span> <span class="fu">dnorm</span>(mu, sigma),</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> a <span class="sc">+</span> bA <span class="sc">*</span> A,</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>  a <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="fl">0.2</span>),</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>  bA <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="fl">0.5</span>),</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>  sigma <span class="sc">~</span> <span class="fu">dexp</span>(<span class="dv">1</span>)</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>), <span class="at">data=</span>d)</span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>m5<span class="fl">.2</span> <span class="ot">&lt;-</span> <span class="fu">quap</span>(<span class="fu">alist</span>(</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>  D <span class="sc">~</span> <span class="fu">dnorm</span>(mu, sigma),</span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> a <span class="sc">+</span> bM <span class="sc">*</span> M,</span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>  a <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="fl">0.2</span>),</span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a>  bM <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="fl">0.5</span>),</span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>  sigma <span class="sc">~</span> <span class="fu">dexp</span>(<span class="dv">1</span>)</span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a>), <span class="at">data=</span>d)</span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a>m5<span class="fl">.3</span> <span class="ot">&lt;-</span> <span class="fu">quap</span>(<span class="fu">alist</span>(</span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a>  D <span class="sc">~</span> <span class="fu">dnorm</span>(mu, sigma),</span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> a <span class="sc">+</span> bM <span class="sc">*</span> M <span class="sc">+</span> bA <span class="sc">*</span> A,</span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a>  a <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="fl">0.2</span>),</span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a>  bM <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="fl">0.5</span>),</span>
<span id="cb37-29"><a href="#cb37-29" aria-hidden="true" tabindex="-1"></a>  bA <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="fl">0.5</span>),</span>
<span id="cb37-30"><a href="#cb37-30" aria-hidden="true" tabindex="-1"></a>  sigma <span class="sc">~</span> <span class="fu">dexp</span>(<span class="dv">1</span>)</span>
<span id="cb37-31"><a href="#cb37-31" aria-hidden="true" tabindex="-1"></a>), <span class="at">data=</span>d)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Just a reminder that Marriage rate <span class="math inline">\(M\)</span> has little association with divorce rate <span class="math inline">\(D\)</span>, once Age <span class="math inline">\(A\)</span> is included into the model <code>m5.3</code>.</p>
<p>Now let’s compare:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">compare</span>(m5<span class="fl">.1</span>, m5<span class="fl">.2</span>, m5<span class="fl">.3</span>, <span class="at">func=</span>PSIS)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Some Pareto k values are high (&gt;0.5). Set pointwise=TRUE to inspect individual points.
Some Pareto k values are high (&gt;0.5). Set pointwise=TRUE to inspect individual points.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Some Pareto k values are very high (&gt;1). Set pointwise=TRUE to inspect individual points.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>         PSIS       SE    dPSIS       dSE    pPSIS      weight
m5.1 126.9733 14.41694  0.00000        NA 4.372411 0.859601814
m5.3 130.6141 15.52562  3.64085  1.558914 6.486203 0.139218472
m5.2 140.1557 10.86663 13.18239 10.458060 3.490896 0.001179714</code></pre>
</div>
</div>
<p>Since <span class="math inline">\(M\)</span> has very little effect on <span class="math inline">\(D\)</span>, removing it from the model and using only <span class="math inline">\(A\)</span> (<code>m5.1</code>) performs very well. Adding <span class="math inline">\(M\)</span> back in <code>m5.3</code> dilutes the effects, but is not significantly different.</p>
<p>Also, notice that we got some warnings for the PSIS of the fits. While there is no warning from WAIC, we would still see some outlier measure by looking at the penalty.</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>PSIS_m5<span class="fl">.3</span> <span class="ot">&lt;-</span> <span class="fu">PSIS</span>(m5<span class="fl">.3</span>, <span class="at">pointwise=</span>T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Some Pareto k values are high (&gt;0.5). Set pointwise=TRUE to inspect individual points.</code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>WAIC_m5<span class="fl">.3</span> <span class="ot">&lt;-</span> <span class="fu">WAIC</span>(m5<span class="fl">.3</span>, <span class="at">pointwise=</span>T)</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(PSIS_m5<span class="fl">.3</span><span class="sc">$</span>k, WAIC_m5<span class="fl">.3</span><span class="sc">$</span>penalty, <span class="at">xlab=</span><span class="st">'PSIS Parteo K'</span>, <span class="at">ylab=</span><span class="st">'WAIC Penalty'</span>, <span class="at">col=</span>rangi2, <span class="at">pch=</span><span class="dv">16</span>)</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v=</span><span class="fl">0.5</span>, <span class="at">lwd=</span><span class="dv">2</span>, <span class="at">lty=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ch7_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
<p>Idaho is the top-right most point and Maine is the second-most outlier. The reason for Idaho is that is has a very low divorce rate for its age at marriage. Recall that the total number of parameters model <code>m5.3</code> is 4, but if we run sum all the penalty terms above, we would get something close to 6.</p>
<p>An alternative here is the use <strong>robust regression</strong>. We will swap out the Gaussian distribution we have been using thus far for the likelihood with a t-distribution. The t-distribution has parameter <span class="math inline">\(\nu\)</span> which controls the thickness of the tails. We’ll use <span class="math inline">\(\nu=2\)</span> for thicker tails be keeping it so that the variance and mean of the student-t is still defined (variance only defined for <span class="math inline">\(\nu &gt; 2\)</span>).</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>m5<span class="fl">.3</span>t <span class="ot">&lt;-</span> <span class="fu">quap</span>(<span class="fu">alist</span>(</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  D <span class="sc">~</span> <span class="fu">dstudent</span>(<span class="dv">2</span>, mu, sigma),</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> a <span class="sc">+</span> bM<span class="sc">*</span>M <span class="sc">+</span> bA<span class="sc">*</span>A,</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>  a <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="fl">0.2</span>),</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>  bM <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="fl">0.5</span>),</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>  bA <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="fl">0.5</span>),</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>  sigma <span class="sc">~</span> <span class="fu">dexp</span>(<span class="dv">1</span>)</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>), <span class="at">data=</span>d)</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">coeftab</span>(m5<span class="fl">.3</span>, m5<span class="fl">.3</span>t), <span class="at">pars=</span><span class="fu">c</span>(<span class="st">'bM'</span>, <span class="st">'bA'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ch7_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>You’ll notice that <span class="math inline">\(\beta_A\)</span> is farther from zero. This is because when Idaho was influential in the model it lowered the coefficient since it had a low divorce rate and a low median age at marriage. Let’s also check the <span class="math inline">\(\hat{k}\)</span> now:</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>PSIS_m5<span class="fl">.3</span> <span class="ot">&lt;-</span> <span class="fu">PSIS</span>(m5<span class="fl">.3</span>t, <span class="at">pointwise=</span>T)</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>WAIC_m5<span class="fl">.3</span> <span class="ot">&lt;-</span> <span class="fu">WAIC</span>(m5<span class="fl">.3</span>t, <span class="at">pointwise=</span>T)</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(PSIS_m5<span class="fl">.3</span><span class="sc">$</span>k, WAIC_m5<span class="fl">.3</span><span class="sc">$</span>penalty, <span class="at">xlab=</span><span class="st">'PSIS Parteo K'</span>, <span class="at">ylab=</span><span class="st">'WAIC Penalty'</span>, <span class="at">col=</span>rangi2, <span class="at">pch=</span><span class="dv">16</span>)</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v=</span><span class="fl">0.5</span>, <span class="at">lwd=</span><span class="dv">2</span>, <span class="at">lty=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ch7_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="exercises" class="level2">
<h2 class="anchored" data-anchor-id="exercises">Exercises</h2>
<section id="m.1" class="level3">
<h3 class="anchored" data-anchor-id="m.1">M.1</h3>
<p>Here is the definition for the AIC:</p>
<p><span class="math display">\[\text{AIC} = D_{\text{Train}} + 2p = -2\text{lppd} + 2p\]</span></p>
<p>where <span class="math inline">\(p\)</span> is the number of free parameters. AIC is relies on the following assumptions:</p>
<ul>
<li>The priors are flat or overwhelmed by the likelihood</li>
<li>The posterior distribution is approx. multivariate Gaussian</li>
<li>The sample size <span class="math inline">\(N\)</span> is much greater than the number of parameters</li>
</ul>
<p>Here is the following definition for WAIC:</p>
<p><span class="math display">\[\text{WAIC}(y,\Theta)=-2 (\text{lppd} - \sum_i\text{var}_{\theta}\log p(y_i|\theta))\]</span> Clearly, WAIC is more general than the AIC. It is able to take the entire posterior into account and does not need to make any assumptions about posterior shape. That said, if the assumptions of the above are met, we should converge to the same value for WAIC and AIC.</p>
</section>
<section id="m.3" class="level3">
<h3 class="anchored" data-anchor-id="m.3">M.3</h3>
<p>For information criteria, we need to use the same observations between models that we are evaluating. If we decide to reduce the number of observations for model <span class="math inline">\(M_1\)</span> when comparing to model <span class="math inline">\(M_2\)</span>, then <span class="math inline">\(M_1\)</span> will be starting at an advantage. Recall, we want a lower deviance or WAIC score. Here is a small example below:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>h0 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,<span class="dv">10</span>,<span class="dv">2</span>)</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>treatment <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="at">each=</span>N<span class="sc">/</span><span class="dv">2</span>)</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>fungus <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(N, <span class="at">size=</span><span class="dv">1</span>, <span class="at">prob=</span><span class="fl">0.5</span> <span class="sc">-</span> treatment<span class="sc">*</span><span class="fl">0.4</span>)</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>h1 <span class="ot">&lt;-</span> h0 <span class="sc">+</span> <span class="fu">rnorm</span>(N, <span class="dv">5</span> <span class="sc">-</span> <span class="dv">3</span><span class="sc">*</span>fungus)</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(h0,h1,treatment, fungus)</span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>m6<span class="fl">.6</span>_high_n <span class="ot">&lt;-</span> <span class="fu">quap</span>(<span class="fu">alist</span>(</span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>  h1 <span class="sc">~</span> <span class="fu">dnorm</span>(mu, sigma),</span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> h0<span class="sc">*</span>p,</span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>  p <span class="sc">~</span> <span class="fu">dlnorm</span>(<span class="dv">0</span>,<span class="fl">0.25</span>),</span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>  sigma <span class="sc">~</span> <span class="fu">dexp</span>(<span class="dv">1</span>)</span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>), <span class="at">data=</span>d)</span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> d[<span class="fu">sample</span>(<span class="fu">nrow</span>(d), <span class="dv">10</span>),]</span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a>m6<span class="fl">.6</span>_low_n <span class="ot">&lt;-</span> <span class="fu">quap</span>(<span class="fu">alist</span>(</span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a>  h1 <span class="sc">~</span> <span class="fu">dnorm</span>(mu, sigma),</span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> h0<span class="sc">*</span>p,</span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a>  p <span class="sc">~</span> <span class="fu">dlnorm</span>(<span class="dv">0</span>,<span class="fl">0.25</span>),</span>
<span id="cb47-23"><a href="#cb47-23" aria-hidden="true" tabindex="-1"></a>  sigma <span class="sc">~</span> <span class="fu">dexp</span>(<span class="dv">1</span>)</span>
<span id="cb47-24"><a href="#cb47-24" aria-hidden="true" tabindex="-1"></a>), <span class="at">data=</span>d)</span>
<span id="cb47-25"><a href="#cb47-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-26"><a href="#cb47-26" aria-hidden="true" tabindex="-1"></a><span class="fu">rbind</span>(<span class="fu">WAIC</span>(m6<span class="fl">.6</span>_high_n), <span class="fu">WAIC</span>(m6<span class="fl">.6</span>_low_n)) <span class="sc">|&gt;</span> <span class="fu">as.data.frame</span>() <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">model=</span><span class="fu">c</span>(<span class="st">'high N'</span>, <span class="st">'low N'</span>)) <span class="sc">|&gt;</span></span>
<span id="cb47-27"><a href="#cb47-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   model      WAIC       lppd  penalty   std_err
1 high N 412.11177 -204.05798 1.997902 14.053061
2  low N  43.74516  -18.23555 3.637031  6.371206</code></pre>
</div>
</div>
<p>Even though it is the same model, with the same DGP, the lower N model fairs better since we are summing over less terms.</p>
<p>In the same vein, we cannot compare two models that are evaluated with different datasets. This is because we want to compare models, not data. If we use two different datasets then we no longer have apples to apples. We won’t be able to tell if it is the <span class="math inline">\(y_i\)</span> in <span class="math inline">\(p(y_i)\)</span> or the actual model that is improving or hurting the deviance.</p>
</section>
<section id="h.1" class="level3">
<h3 class="anchored" data-anchor-id="h.1">H.1</h3>
<p>There was a poorly drawn curve in the WSJ fitting some data on tax rates. Let’s correctly draw some curves predicting tax revenue from tax rate.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(Laffer)</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> Laffer</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(tax_revenue <span class="sc">~</span> tax_rate, <span class="at">data=</span>d, <span class="at">pch=</span><span class="dv">16</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ch7_files/figure-html/unnamed-chunk-27-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Let’s try four models. An intercept only, a linear, a quadratic, and a log.</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>m_h.<span class="fl">1.1</span> <span class="ot">&lt;-</span> <span class="fu">quap</span>(<span class="fu">alist</span>(</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>  tax_revenue <span class="sc">~</span> <span class="fu">dnorm</span>(mu, sig),</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> a,</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>  a <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="dv">1</span>),</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>  sig <span class="sc">~</span> <span class="fu">dexp</span>(<span class="dv">1</span>)</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>), <span class="at">data=</span>d)</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>m_h.<span class="fl">1.2</span> <span class="ot">&lt;-</span> <span class="fu">quap</span>(<span class="fu">alist</span>(</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>  tax_revenue <span class="sc">~</span> <span class="fu">dnorm</span>(mu, sig),</span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> a <span class="sc">+</span> bX[<span class="dv">1</span>]<span class="sc">*</span>tax_rate,</span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>  bX <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="dv">2</span>),</span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>  a <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="dv">1</span>),</span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>  sig <span class="sc">~</span> <span class="fu">dexp</span>(<span class="dv">1</span>)</span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>), <span class="at">data=</span>d, <span class="at">start=</span><span class="fu">list</span>(<span class="at">bX=</span><span class="fu">rep</span>(<span class="dv">0</span>,<span class="dv">1</span>)))</span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a>m_h.<span class="fl">1.3</span> <span class="ot">&lt;-</span> <span class="fu">quap</span>(<span class="fu">alist</span>(</span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a>  tax_revenue <span class="sc">~</span> <span class="fu">dnorm</span>(mu, sig),</span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> a <span class="sc">+</span> bX[<span class="dv">1</span>]<span class="sc">*</span>tax_rate <span class="sc">+</span> bX[<span class="dv">2</span>]<span class="sc">*</span>tax_rate<span class="sc">^</span><span class="dv">2</span>,</span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a>  bX <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="dv">2</span>),</span>
<span id="cb50-20"><a href="#cb50-20" aria-hidden="true" tabindex="-1"></a>  a <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="dv">1</span>),</span>
<span id="cb50-21"><a href="#cb50-21" aria-hidden="true" tabindex="-1"></a>  sig <span class="sc">~</span> <span class="fu">dexp</span>(<span class="dv">1</span>)</span>
<span id="cb50-22"><a href="#cb50-22" aria-hidden="true" tabindex="-1"></a>), <span class="at">data=</span>d, <span class="at">start=</span><span class="fu">list</span>(<span class="at">bX=</span><span class="fu">rep</span>(<span class="dv">0</span>,<span class="dv">2</span>)))</span>
<span id="cb50-23"><a href="#cb50-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-24"><a href="#cb50-24" aria-hidden="true" tabindex="-1"></a>m_h.<span class="fl">1.4</span> <span class="ot">&lt;-</span> <span class="fu">quap</span>(<span class="fu">alist</span>(</span>
<span id="cb50-25"><a href="#cb50-25" aria-hidden="true" tabindex="-1"></a>  tax_revenue <span class="sc">~</span> <span class="fu">dnorm</span>(mu, sig),</span>
<span id="cb50-26"><a href="#cb50-26" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> a <span class="sc">+</span> bX[<span class="dv">1</span>]<span class="sc">*</span>tax_rate <span class="sc">+</span> bX[<span class="dv">2</span>]<span class="sc">*</span>tax_rate<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> bX[<span class="dv">3</span>]<span class="sc">*</span>tax_rate<span class="sc">^</span><span class="dv">3</span>,</span>
<span id="cb50-27"><a href="#cb50-27" aria-hidden="true" tabindex="-1"></a>  bX <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="dv">2</span>),</span>
<span id="cb50-28"><a href="#cb50-28" aria-hidden="true" tabindex="-1"></a>  a <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="dv">1</span>),</span>
<span id="cb50-29"><a href="#cb50-29" aria-hidden="true" tabindex="-1"></a>  sig <span class="sc">~</span> <span class="fu">dexp</span>(<span class="dv">1</span>)</span>
<span id="cb50-30"><a href="#cb50-30" aria-hidden="true" tabindex="-1"></a>), <span class="at">data=</span>d, <span class="at">start=</span><span class="fu">list</span>(<span class="at">bX=</span><span class="fu">rep</span>(<span class="dv">0</span>,<span class="dv">3</span>)))</span>
<span id="cb50-31"><a href="#cb50-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-32"><a href="#cb50-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-33"><a href="#cb50-33" aria-hidden="true" tabindex="-1"></a>x_seq <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="fl">0.5</span>, <span class="dv">40</span>)</span>
<span id="cb50-34"><a href="#cb50-34" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(tax_revenue <span class="sc">~</span> tax_rate, <span class="at">data=</span>d, <span class="at">pch=</span><span class="dv">16</span>)</span>
<span id="cb50-35"><a href="#cb50-35" aria-hidden="true" tabindex="-1"></a>m_h.<span class="fl">1.1</span> <span class="sc">|&gt;</span> <span class="fu">link</span>(<span class="at">data=</span><span class="fu">list</span>(<span class="at">tax_rate=</span>x_seq)) <span class="sc">|&gt;</span> <span class="fu">colMeans</span>() <span class="sc">|&gt;</span> <span class="fu">lines</span>(<span class="at">x=</span>x_seq, <span class="at">y=</span>_, <span class="at">lwd=</span><span class="dv">2</span>, <span class="at">col=</span><span class="dv">1</span>)</span>
<span id="cb50-36"><a href="#cb50-36" aria-hidden="true" tabindex="-1"></a>m_h.<span class="fl">1.2</span> <span class="sc">|&gt;</span> <span class="fu">link</span>(<span class="at">data=</span><span class="fu">list</span>(<span class="at">tax_rate=</span>x_seq)) <span class="sc">|&gt;</span> <span class="fu">colMeans</span>() <span class="sc">|&gt;</span> <span class="fu">lines</span>(<span class="at">x=</span>x_seq, <span class="at">y=</span>_, <span class="at">lwd=</span><span class="dv">2</span>, <span class="at">col=</span><span class="dv">2</span>)</span>
<span id="cb50-37"><a href="#cb50-37" aria-hidden="true" tabindex="-1"></a>m_h.<span class="fl">1.3</span> <span class="sc">|&gt;</span> <span class="fu">link</span>(<span class="at">data=</span><span class="fu">list</span>(<span class="at">tax_rate=</span>x_seq)) <span class="sc">|&gt;</span> <span class="fu">colMeans</span>() <span class="sc">|&gt;</span> <span class="fu">lines</span>(<span class="at">x=</span>x_seq, <span class="at">y=</span>_, <span class="at">lwd=</span><span class="dv">2</span>, <span class="at">col=</span><span class="dv">3</span>)</span>
<span id="cb50-38"><a href="#cb50-38" aria-hidden="true" tabindex="-1"></a>m_h.<span class="fl">1.4</span> <span class="sc">|&gt;</span> <span class="fu">link</span>(<span class="at">data=</span><span class="fu">list</span>(<span class="at">tax_rate=</span>x_seq)) <span class="sc">|&gt;</span> <span class="fu">colMeans</span>() <span class="sc">|&gt;</span> <span class="fu">lines</span>(<span class="at">x=</span>x_seq, <span class="at">y=</span>_, <span class="at">lwd=</span><span class="dv">2</span>, <span class="at">col=</span><span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ch7_files/figure-html/unnamed-chunk-28-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
<p>Let’s use WAIC to see how they performed.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">compare</span>(m_h.<span class="fl">1.1</span>, m_h.<span class="fl">1.2</span>, m_h.<span class="fl">1.3</span>, m_h.<span class="fl">1.4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>            WAIC       SE     dWAIC      dSE    pWAIC     weight
m_h.1.4 125.0069 24.12778 0.0000000       NA 8.480274 0.38856944
m_h.1.3 125.4215 26.45398 0.4145687 3.170750 8.351372 0.31582478
m_h.1.2 126.3209 24.80603 1.3140086 3.697868 7.174815 0.20143517
m_h.1.1 127.8416 23.94002 2.8347276 4.970262 6.338242 0.09417061</code></pre>
</div>
</div>
<p>It actually looks like the curve, either the cubic or the quadratic doesn’t help us much. The difference between the linear and the quadtratic is 2.1, but the SE is 2.97. A plot might be easier to see:</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu">compare</span>(m_h.<span class="fl">1.1</span>, m_h.<span class="fl">1.2</span>, m_h.<span class="fl">1.3</span>, m_h.<span class="fl">1.4</span>) <span class="sc">|&gt;</span> <span class="fu">plot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ch7_files/figure-html/unnamed-chunk-30-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
<p>Recall the that filled in dots are the in-sample deviance. The hollow dots are the WAIC. It appears that even the intercept only model isn’t much better than the quadratic model. Also, look at the <span class="math inline">\(p_{\text{WAIC}}\)</span> terms. My guess is that we would see some high <span class="math inline">\(\hat{k}\)</span> values had we used PSIS.</p>
</section>
<section id="h.2" class="level3">
<h3 class="anchored" data-anchor-id="h.2">H.2</h3>
<p>Let’s look at the importance of the one outlier in the dataset using both WAIC and PSIS. We’ll use the quadratic model for this.</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>PSIS_m_h.<span class="fl">1.3</span> <span class="ot">&lt;-</span> <span class="fu">PSIS</span>(m_h.<span class="fl">1.3</span>, <span class="at">pointwise=</span>T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Some Pareto k values are very high (&gt;1). Set pointwise=TRUE to inspect individual points.</code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>WAIC_m_h.<span class="fl">1.3</span> <span class="ot">&lt;-</span> <span class="fu">WAIC</span>(m_h.<span class="fl">1.3</span>, <span class="at">pointwise=</span>T)</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(PSIS_m_h.<span class="fl">1.3</span><span class="sc">$</span>k, WAIC_m_h.<span class="fl">1.3</span><span class="sc">$</span>penalty, <span class="at">xlab=</span><span class="st">'PSIS Parteo K'</span>, <span class="at">ylab=</span><span class="st">'WAIC Penalty'</span>, <span class="at">col=</span>rangi2, <span class="at">pch=</span><span class="dv">16</span>)</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v=</span><span class="fl">0.5</span>, <span class="at">lwd=</span><span class="dv">2</span>, <span class="at">lty=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ch7_files/figure-html/unnamed-chunk-31-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
<p>Wow, that is crazy. Let’s see what happens if we use the t-distribution for the likelihood to corect for this:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>m_h.<span class="fl">1.3</span>t <span class="ot">&lt;-</span> <span class="fu">quap</span>(<span class="fu">alist</span>(</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>  tax_revenue <span class="sc">~</span> <span class="fu">dstudent</span>(<span class="dv">2</span>, mu, sig),</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> a <span class="sc">+</span> bX[<span class="dv">1</span>]<span class="sc">*</span>tax_rate <span class="sc">+</span> bX[<span class="dv">2</span>]<span class="sc">*</span>tax_rate<span class="sc">^</span><span class="dv">2</span>,</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>  bX <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="dv">2</span>),</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>  a <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="dv">1</span>),</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>  sig <span class="sc">~</span> <span class="fu">dexp</span>(<span class="dv">1</span>)</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>), <span class="at">data=</span>d, <span class="at">start=</span><span class="fu">list</span>(<span class="at">bX=</span><span class="fu">rep</span>(<span class="dv">0</span>,<span class="dv">2</span>)))</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>PSIS_m_h.<span class="fl">1.3</span>t <span class="ot">&lt;-</span> <span class="fu">PSIS</span>(m_h.<span class="fl">1.3</span>t, <span class="at">pointwise=</span>T)</span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>WAIC_m_h.<span class="fl">1.3</span>t <span class="ot">&lt;-</span> <span class="fu">WAIC</span>(m_h.<span class="fl">1.3</span>t, <span class="at">pointwise=</span>T)</span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(PSIS_m_h.<span class="fl">1.3</span>t<span class="sc">$</span>k, WAIC_m_h.<span class="fl">1.3</span>t<span class="sc">$</span>penalty, <span class="at">xlab=</span><span class="st">'PSIS Parteo K'</span>, <span class="at">ylab=</span><span class="st">'WAIC Penalty'</span>, <span class="at">col=</span>rangi2, <span class="at">pch=</span><span class="dv">16</span>)</span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v=</span><span class="fl">0.5</span>, <span class="at">lwd=</span><span class="dv">2</span>, <span class="at">lty=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ch7_files/figure-html/unnamed-chunk-32-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Still not great, but much better!</p>
</section>
<section id="h.3" class="level3">
<h3 class="anchored" data-anchor-id="h.3">H.3</h3>
<p>Let’s build the bird dataframe. Columns are the islands and rows represent the respective species:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>birds <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">i_1=</span><span class="fu">c</span>(<span class="fl">0.2</span>, <span class="fl">0.2</span>, <span class="fl">0.2</span>, <span class="fl">0.2</span>, <span class="fl">0.2</span>),</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>                    <span class="at">i_2=</span><span class="fu">c</span>(<span class="fl">0.8</span>, <span class="fl">0.1</span>, <span class="fl">0.05</span>, <span class="fl">0.025</span>, <span class="fl">0.025</span>),</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>                    <span class="at">i_3=</span><span class="fu">c</span>(<span class="fl">0.05</span>, <span class="fl">0.15</span>, <span class="fl">0.7</span>, <span class="fl">0.05</span>, <span class="fl">0.05</span>))</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a><span class="fu">colSums</span>(birds)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>i_1 i_2 i_3 
  1   1   1 </code></pre>
</div>
</div>
<p>Let’s compute the entropy of each island’s distribution. Recall that entropy is given by:</p>
<p><span class="math display">\[H(p)=-E_p[\log(p_i)]=-\sum^n_{i=1}p_i\log(p_i)\]</span></p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>entropy <span class="ot">&lt;-</span> <span class="fu">apply</span>(birds, <span class="dv">2</span>, \(x) <span class="sc">-</span><span class="fu">sum</span>(x<span class="sc">*</span><span class="fu">log</span>(x)))</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>entropy</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>      i_1       i_2       i_3 
1.6094379 0.7430039 0.9836003 </code></pre>
</div>
</div>
<p>Let’s now compute the KL divergence between the various islands. We are going to iterate through a assume that one island is the truth and then calculate the KL divergence as if the other two are the predictions. Recall that the KL divergence is given by:</p>
<p><span class="math display">\[D_{\text{KL}}(p,q)=\sum_i p_i \log(p_i/q_i)\]</span></p>
<p>where <span class="math inline">\(p_i\)</span> is the truth and <span class="math inline">\(q_i\)</span> is the prediction.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>kl <span class="ot">&lt;-</span> <span class="cf">function</span>(truth, pred){</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sum</span>(truth <span class="sc">*</span> <span class="fu">log</span>(truth<span class="sc">/</span>pred))</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>comp <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">truth=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">pred=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>) <span class="sc">|&gt;</span> <span class="fu">filter</span>(truth <span class="sc">!=</span> pred) <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">KL =</span> <span class="cn">NA</span>) <span class="sc">|&gt;</span> <span class="fu">arrange</span>(truth, pred)</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(comp)){</span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>  comp[i,<span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="fu">kl</span>(birds[[comp[i,<span class="dv">1</span>]]], birds[[comp[i,<span class="dv">2</span>]]])</span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>comp</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  truth pred        KL
1     1    2 0.9704061
2     1    3 0.6387604
3     2    1 0.8664340
4     2    3 2.0109142
5     3    1 0.6258376
6     3    2 1.8388452</code></pre>
</div>
</div>
<p>Now let’s see which island predicts the other best</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>comp <span class="sc">|&gt;</span> <span class="fu">arrange</span>(KL)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  truth pred        KL
1     3    1 0.6258376
2     1    3 0.6387604
3     2    1 0.8664340
4     1    2 0.9704061
5     3    2 1.8388452
6     2    3 2.0109142</code></pre>
</div>
</div>
<p>Looks like 1 predicts 3 best and vice versa. It makes sense since island 1 is essentially a flat distribution and island 3 doesn’t have any extremely high/low values like island 2.</p>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>