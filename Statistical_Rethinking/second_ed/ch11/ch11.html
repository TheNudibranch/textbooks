<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Rethinking - Chapter 11</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="ch11_files/libs/clipboard/clipboard.min.js"></script>
<script src="ch11_files/libs/quarto-html/quarto.js"></script>
<script src="ch11_files/libs/quarto-html/popper.min.js"></script>
<script src="ch11_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="ch11_files/libs/quarto-html/anchor.min.js"></script>
<link href="ch11_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="ch11_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="ch11_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="ch11_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="ch11_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#section" id="toc-section" class="nav-link active" data-scroll-target="#section">11.0</a></li>
  <li><a href="#binomial-regression" id="toc-binomial-regression" class="nav-link" data-scroll-target="#binomial-regression">11.1 - Binomial Regression</a>
  <ul class="collapse">
  <li><a href="#aggregate-binomial" id="toc-aggregate-binomial" class="nav-link" data-scroll-target="#aggregate-binomial">Aggregate Binomial</a></li>
  </ul></li>
  <li><a href="#poisson-regression" id="toc-poisson-regression" class="nav-link" data-scroll-target="#poisson-regression">11.2 - Poisson Regression</a>
  <ul class="collapse">
  <li><a href="#negative-binomial" id="toc-negative-binomial" class="nav-link" data-scroll-target="#negative-binomial">11.2.2 Negative Binomial</a></li>
  <li><a href="#exposure-and-offset" id="toc-exposure-and-offset" class="nav-link" data-scroll-target="#exposure-and-offset">11.2.3 Exposure and Offset</a></li>
  </ul></li>
  <li><a href="#multinomial-and-categorical-models" id="toc-multinomial-and-categorical-models" class="nav-link" data-scroll-target="#multinomial-and-categorical-models">11.3 - Multinomial and categorical models</a>
  <ul class="collapse">
  <li><a href="#predictors-matched-to-outcomes" id="toc-predictors-matched-to-outcomes" class="nav-link" data-scroll-target="#predictors-matched-to-outcomes">11.3.1 Predictors matched to outcomes</a></li>
  <li><a href="#predictors-matched-to-observations" id="toc-predictors-matched-to-observations" class="nav-link" data-scroll-target="#predictors-matched-to-observations">11.3.1 Predictors matched to observations</a></li>
  <li><a href="#multinomial-in-disguise-as-poisson" id="toc-multinomial-in-disguise-as-poisson" class="nav-link" data-scroll-target="#multinomial-in-disguise-as-poisson">11.3.2 Multinomial in disguise as Poisson</a></li>
  </ul></li>
  <li><a href="#excersises" id="toc-excersises" class="nav-link" data-scroll-target="#excersises">Excersises</a>
  <ul class="collapse">
  <li><a href="#m5" id="toc-m5" class="nav-link" data-scroll-target="#m5">M5</a></li>
  <li><a href="#h2" id="toc-h2" class="nav-link" data-scroll-target="#h2">H2</a></li>
  <li><a href="#h3" id="toc-h3" class="nav-link" data-scroll-target="#h3">H3</a></li>
  <li><a href="#h6" id="toc-h6" class="nav-link" data-scroll-target="#h6">H6</a></li>
  </ul></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Rethinking - Chapter 11</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rethinking)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dagitty)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="section" class="level2">
<h2 class="anchored" data-anchor-id="section">11.0</h2>
<ul>
<li>We’ll spend our time on Binomial and Poisson regression in this chapter</li>
</ul>
</section>
<section id="binomial-regression" class="level2">
<h2 class="anchored" data-anchor-id="binomial-regression">11.1 - Binomial Regression</h2>
<ul>
<li>Binomial distribution has maximum entropy when the result must be one of two events and the expected value is constant across trials</li>
<li>Two common flavors of GLM that use binomial probability:
<ul>
<li>Logistic Regression: single trial 0/1</li>
<li>Aggregated Binomial Regression</li>
</ul></li>
<li>Both use logistic link and can be convereted between one another</li>
</ul>
<p>Let’s look at some chimp data. There are four plates on a rectangular table. There is a right and a left lever. If one of the levers is pulled, the two plates on that side of the table are sent to their respective ends. One side of the table might have food only on the plate that will be delivered to the chimp pulling the lever. The other side might have both plates filled, delivering food to both the chimp pulling the lever as well as the one seated across the table. This would be the <em>prosocial</em> option. Let’s see what we can find as the interaction between condition (presence or absence of another animal) and option (which side would be the prosocial option).</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(chimpanzees)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> chimpanzees</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We are interested in estimating the interaction between <code>prosoc_left</code>, meaning that the prosocial option is the left lever, and <code>conidition</code>, a 1 if there is another chimp seated across the table.</p>
<p>The conventional way to do this would be to construct a linear interaction between the two variables, but that makes it hard to determine different priors. Instead, let’s build an index variable from 1 to 4. We can visualize it with the <code>xtabs</code> function:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>d<span class="sc">$</span>treatment <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">+</span> d<span class="sc">$</span>prosoc_left <span class="sc">+</span> <span class="dv">2</span><span class="sc">*</span>d<span class="sc">$</span>condition</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">xtabs</span>(<span class="sc">~</span> treatment <span class="sc">+</span> prosoc_left <span class="sc">+</span> condition, d)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>, , condition = 0

         prosoc_left
treatment   0   1
        1 126   0
        2   0 126
        3   0   0
        4   0   0

, , condition = 1

         prosoc_left
treatment   0   1
        1   0   0
        2   0   0
        3 126   0
        4   0 126</code></pre>
</div>
</div>
<p>The model is of the form:</p>
<p><span class="math display">\[\begin{align}
L &amp;\sim \text{Binomial}(1,p_i)\\
\text{logit}(p_i) &amp;= \alpha_{\text{ACTOR}[i]} + \beta_{\text{TREATMENT}[i]}\\
\alpha_j &amp;\sim \text{to be determined}\\
\beta_k &amp;\sim \text{to be determined}\\
\end{align}\]</span></p>
<p>We could of course defined <span class="math inline">\(L\)</span> to be a simple Bernoulli since it only has one trial.</p>
<p>Before we actually dive into the full model, let’s try something simple to warm up our prior predictive juices:</p>
<p><span class="math display">\[\begin{align}
L &amp;\sim \text{Binomial}(1,p_i)\\
\text{logit}(p_i) &amp;= \alpha\\
\alpha &amp;\sim \text{Normal}(0,\omega)\\
\end{align}\]</span></p>
<p>Let’s choose <span class="math inline">\(\omega=10\)</span> for our value:</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>m11<span class="fl">.1</span> <span class="ot">&lt;-</span> <span class="fu">quap</span>(<span class="fu">alist</span>(</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  pulled_left <span class="sc">~</span> <span class="fu">dbinom</span>(<span class="dv">1</span>, p),</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">logit</span>(p) <span class="ot">&lt;-</span> a,</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  a <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="dv">10</span>)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>), <span class="at">data=</span>d)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>prior <span class="ot">&lt;-</span> <span class="fu">extract.prior</span>(m11<span class="fl">.1</span>, <span class="at">n=</span><span class="fl">1e4</span>)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">inv_logit</span>(prior<span class="sc">$</span>a)</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="fu">dens</span>(p, <span class="at">adj=</span><span class="fl">0.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ch11_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
<p>The model here is telling us that the chimp will almost never, or always pull the lever. There is no grey area. This implies that a flat prior in the logit space is not a flat prior in the outcome space. Let’s stick with <span class="math inline">\(\omega=1.5\)</span> which will give us a much better behaved shape. Now, we could probably just use 1.5 again for <span class="math inline">\(\beta\)</span>, but let’s see what happens if we don’t:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>m11<span class="fl">.2</span> <span class="ot">&lt;-</span> <span class="fu">quap</span>(<span class="fu">alist</span>(</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  pulled_left <span class="sc">~</span> <span class="fu">dbinom</span>(<span class="dv">1</span>, p),</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">logit</span>(p) <span class="ot">&lt;-</span> a <span class="sc">+</span> b[treatment],</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  a <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="fl">1.5</span>),</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  b[treatment] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="dv">10</span>)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>), <span class="at">data=</span>d)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>prior <span class="ot">&lt;-</span> <span class="fu">extract.prior</span>(m11<span class="fl">.2</span>)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>, \(x) <span class="fu">inv_logit</span>(prior<span class="sc">$</span>a <span class="sc">+</span> prior<span class="sc">$</span>b[,x])) <span class="sc">|&gt;</span> <span class="fu">as.data.frame</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Let’s see what the priors imply about the prior <em>differences</em> between the treatments, since that is what we are really after.</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dens</span>(<span class="fu">abs</span>(p[,<span class="dv">1</span>] <span class="sc">-</span> p[,<span class="dv">2</span>]), <span class="at">adj=</span><span class="fl">0.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ch11_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
<p>Here the model thinks that the treatments are either completely alike, or completely different. Let’s try a 0.5 scale:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>m11<span class="fl">.3</span> <span class="ot">&lt;-</span> <span class="fu">quap</span>(<span class="fu">alist</span>(</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  pulled_left <span class="sc">~</span> <span class="fu">dbinom</span>(<span class="dv">1</span>, p),</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">logit</span>(p) <span class="ot">&lt;-</span> a <span class="sc">+</span> b[treatment],</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  a <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="fl">1.5</span>),</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  b[treatment] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="fl">0.5</span>)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>), <span class="at">data=</span>d)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>prior <span class="ot">&lt;-</span> <span class="fu">extract.prior</span>(m11<span class="fl">.3</span>)</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>, \(x) <span class="fu">inv_logit</span>(prior<span class="sc">$</span>a <span class="sc">+</span> prior<span class="sc">$</span>b[,x])) <span class="sc">|&gt;</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>(p[,<span class="dv">1</span>] <span class="sc">-</span> p[,<span class="dv">2</span>]) <span class="sc">|&gt;</span> <span class="fu">abs</span>() <span class="sc">|&gt;</span> <span class="fu">mean</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.09567778</code></pre>
</div>
</div>
<p>Now the average prior difference is about 10%. Extremely large differences are very unlikely now - this will help reduce overfitting.</p>
<p>Let’s go ahead and fit the model using HMC:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>dat_list <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">pulled_left =</span> d<span class="sc">$</span>pulled_left,</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">actor =</span> d<span class="sc">$</span>actor,</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">treatment =</span> d<span class="sc">$</span>treatment</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>m11<span class="fl">.4</span> <span class="ot">&lt;-</span> <span class="fu">ulam</span>(<span class="fu">alist</span>(</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  pulled_left <span class="sc">~</span> <span class="fu">dbinom</span>(<span class="dv">1</span>, p),</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">logit</span>(p) <span class="ot">&lt;-</span> a[actor] <span class="sc">+</span> b[treatment],</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  a[actor] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="fl">1.5</span>),</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>  b[treatment] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>, <span class="fl">0.5</span>)</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>), <span class="at">data=</span>dat_list, <span class="at">chains=</span><span class="dv">4</span>, <span class="at">log_lik=</span>T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">precis</span>(m11<span class="fl">.4</span>, <span class="at">depth=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>           mean        sd        5.5%       94.5%     rhat  ess_bulk
a[1] -0.4640328 0.3294261 -0.99397196  0.06699429 1.007694  624.8181
a[2]  3.8823678 0.7503528  2.81642850  5.17131370 1.002282 1314.5949
a[3] -0.7643757 0.3429404 -1.31843440 -0.21115986 1.006265  585.9226
a[4] -0.7511400 0.3434110 -1.30305660 -0.20905960 1.005578  542.4115
a[5] -0.4544432 0.3318449 -0.97309533  0.05901739 1.005242  614.6827
a[6]  0.4709241 0.3393561 -0.08415782  1.00184380 1.004859  723.9353
a[7]  1.9503810 0.4316035  1.27983790  2.66879700 1.005830  831.1054
b[1] -0.0400770 0.2923804 -0.49397846  0.43193694 1.007118  566.5346
b[2]  0.4934814 0.2894652  0.03311294  0.95810253 1.007215  537.0348
b[3] -0.3792760 0.2918320 -0.85050965  0.08267004 1.009132  522.0213
b[4]  0.3798079 0.2901727 -0.08333671  0.85204792 1.007317  582.0832</code></pre>
</div>
</div>
<p>Let’s look at the chimps behavior on the outcome scale:</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>post <span class="ot">&lt;-</span> <span class="fu">extract.samples</span>(m11<span class="fl">.4</span>)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>p_left <span class="ot">&lt;-</span> <span class="fu">inv_logit</span>(post<span class="sc">$</span>a)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">precis</span>(<span class="fu">as.data.frame</span>(p_left)), <span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ch11_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
<p>Now, let’s see how the treatments look:</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>labs <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'R/N'</span>, <span class="st">'L/N'</span>, <span class="st">'R/P'</span>, <span class="st">'L/P'</span>)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">precis</span>(m11<span class="fl">.4</span>, <span class="at">depth=</span><span class="dv">2</span>, <span class="at">pars=</span><span class="st">'b'</span>), <span class="at">labels=</span>labs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ch11_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
<p>Here “R/N” means prosocial on right and no partner. What we want to see is if the chimp chose the prosocial option in the presence of a partner or not. For this we want to compare the difference between the first and third (top down), and second and fourth:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>diffs <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">db13 =</span> post<span class="sc">$</span>b[,<span class="dv">1</span>] <span class="sc">-</span> post<span class="sc">$</span>b[,<span class="dv">3</span>],</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">db24 =</span> post<span class="sc">$</span>b[,<span class="dv">2</span>] <span class="sc">-</span> post<span class="sc">$</span>b[,<span class="dv">4</span>]</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">precis</span>(diffs))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ch11_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>These are <strong>contrasts</strong> between no-partner/partner treatments on the log-odds scale. Clearly there isn’t any compelling evidence of prosocial choice in this experiment.</p>
<p>For our next inspection, let’s see how our posterior predictions faired against the actual data on the actor/treatment level:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>pl <span class="ot">&lt;-</span> <span class="fu">by</span>(d<span class="sc">$</span>pulled_left, <span class="fu">list</span>(d<span class="sc">$</span>actor, d<span class="sc">$</span>treatment), mean)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>pl[,<span class="dv">1</span>] <span class="co"># average pulls by treatment for chimp 1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>        1         2         3         4         5         6         7 
0.3333333 1.0000000 0.2777778 0.3333333 0.3333333 0.7777778 0.7777778 </code></pre>
</div>
</div>
<p>I won’t write out the whole code for visualizing, but you’ll see that we are pretty consistent with what the actual data shows. The big factor is handedness of the chimps.</p>
<p>Let’s try a simpler model where we don’t include an interaction - just the two separate variables that made up the interaction:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>d<span class="sc">$</span>side <span class="ot">&lt;-</span> d<span class="sc">$</span>prosoc_left <span class="sc">+</span> <span class="dv">1</span> <span class="co"># right 1, left 2</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>d<span class="sc">$</span>cond <span class="ot">&lt;-</span> d<span class="sc">$</span>condition <span class="sc">+</span> <span class="dv">1</span> <span class="co"># no partner 1, partner 2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>dat_list2 <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">pulled_left=</span>d<span class="sc">$</span>pulled_left,</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">actor =</span> d<span class="sc">$</span>actor,</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">side =</span> d<span class="sc">$</span>side,</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">cond =</span> d<span class="sc">$</span>cond</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>m11<span class="fl">.5</span> <span class="ot">&lt;-</span> <span class="fu">ulam</span>(<span class="fu">alist</span>(</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>  pulled_left <span class="sc">~</span> <span class="fu">dbinom</span>(<span class="dv">1</span>, p),</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">logit</span>(p) <span class="ot">&lt;-</span> a[actor] <span class="sc">+</span> bs[side] <span class="sc">+</span> bc[cond],</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>  a[actor] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="fl">1.5</span>),</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>  bs[side] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>, <span class="fl">0.5</span>),</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>  bc[cond] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>, <span class="fl">0.5</span>)</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>), <span class="at">data=</span>dat_list2, <span class="at">chains=</span><span class="dv">4</span>, <span class="at">log_lik=</span>T, <span class="at">cores=</span><span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">compare</span>(m11<span class="fl">.5</span>, m11<span class="fl">.4</span>, <span class="at">func=</span>PSIS)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>          PSIS       SE    dPSIS      dSE    pPSIS    weight
m11.5 530.8195 19.02102 0.000000       NA 7.742572 0.7127731
m11.4 532.6372 19.00129 1.817782 1.202609 8.701061 0.2872269</code></pre>
</div>
</div>
<p>Just as we thought - the simpler model is actually better. This is because the model actually has more data and can better estimate the parameters separately instead of trying to force them together.</p>
<p>So far we have been talking about <strong>absolute effects</strong>: the difference a counter-factual change in a variable makes on the measurement scale. i.e.&nbsp;if we change the condition to be prosocial, we see the probability increase by 10 points. Now we are going to talk about the <strong>relative effects</strong>: the multiplier a change in effect has on the outcome. i.e.&nbsp;if we change the condition to be prosocial we double the outcome of an event. For example, the proportional odds of switching from treatment 2 to treatment 4 (adding a partner):</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>post <span class="ot">&lt;-</span> <span class="fu">extract.samples</span>(m11<span class="fl">.4</span>)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(<span class="fu">exp</span>(post<span class="sc">$</span>b[,<span class="dv">4</span>] <span class="sc">-</span> post<span class="sc">$</span>b[,<span class="dv">2</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.9254744</code></pre>
</div>
</div>
<p>This means that the switch multiples the odds of pulling the left lever by 0.92. A 8% reduction in odds (this is <strong>proportional odds</strong>). Clearly, this is not enough though. If the other variables in the model make the outcome unlikely, ten a large proportional odds like 5x would not make the outcome likely.</p>
<section id="aggregate-binomial" class="level3">
<h3 class="anchored" data-anchor-id="aggregate-binomial">Aggregate Binomial</h3>
<p>There is nothing stopping us from doing a aggregated count model instead sice there is no need to preserve order. This can actually make things much faster since there is less data:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>d_aggregated <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  d<span class="sc">$</span>pulled_left,</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">treatment=</span>d<span class="sc">$</span>treatment, </span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>       <span class="at">actor=</span>d<span class="sc">$</span>actor,</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>       <span class="at">side=</span>d<span class="sc">$</span>side,</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">cond=</span>d<span class="sc">$</span>cond),</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>  sum</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(d_aggregated)[<span class="dv">5</span>] <span class="ot">&lt;-</span> <span class="st">'left_pulls'</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>d_aggregated <span class="sc">|&gt;</span> <span class="fu">head</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  treatment actor side cond left_pulls
1         1     1    1    1          6
2         1     2    1    1         18
3         1     3    1    1          5
4         1     4    1    1          6
5         1     5    1    1          6
6         1     6    1    1         14</code></pre>
</div>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>d <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(treatment, actor, side, cond) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">left_pulls=</span><span class="fu">sum</span>(pulled_left), <span class="at">cnt=</span><span class="fu">n</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'treatment', 'actor', 'side'. You can
override using the `.groups` argument.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 28 × 6
# Groups:   treatment, actor, side [28]
   treatment actor  side  cond left_pulls   cnt
       &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt;      &lt;int&gt; &lt;int&gt;
 1         1     1     1     1          6    18
 2         1     2     1     1         18    18
 3         1     3     1     1          5    18
 4         1     4     1     1          6    18
 5         1     5     1     1          6    18
 6         1     6     1     1         14    18
 7         1     7     1     1         14    18
 8         2     1     2     1          9    18
 9         2     2     2     1         18    18
10         2     3     2     1         11    18
# ℹ 18 more rows</code></pre>
</div>
</div>
<p>Something that is very important to note is that there were exactly 18 trials for each chimp and set of conditions. If they were different, we would have to change <span class="math inline">\(N\)</span> for each point (not hard to do though).</p>
<p>Let’s fit the full model:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>m11<span class="fl">.6</span> <span class="ot">&lt;-</span> <span class="fu">ulam</span>(<span class="fu">alist</span>(</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  left_pulls <span class="sc">~</span> <span class="fu">dbinom</span>(<span class="dv">18</span>, p),</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">logit</span>(p) <span class="ot">&lt;-</span> a[actor] <span class="sc">+</span> b[treatment],</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>  a[actor] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>, <span class="fl">1.5</span>),</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>  b[treatment] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="fl">1.5</span>)</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>), <span class="at">data=</span><span class="fu">as.list</span>(d_aggregated), <span class="at">chains=</span><span class="dv">4</span>, <span class="at">cores=</span><span class="dv">4</span>, <span class="at">log_lik=</span>T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>And compare to the identical model <code>m11.4</code>:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">compare</span>(m11<span class="fl">.4</span>, m11<span class="fl">.6</span>, <span class="at">func=</span>PSIS)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in compare(m11.4, m11.6, func = PSIS): Different numbers of observations found for at least two models.
Model comparison is valid only for models fit to exactly the same observations.
Number of observations for each model:
m11.4 504 
m11.6 28 </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Some Pareto k values are high (&gt;0.5). Set pointwise=TRUE to inspect individual points.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>          PSIS        SE    dPSIS      dSE    pPSIS       weight
m11.6 114.8420  8.684858   0.0000       NA 8.905914 1.000000e+00
m11.4 532.6372 19.001292 417.7953 41.30645 8.701061 1.891969e-91</code></pre>
</div>
</div>
<p>The PSIS scores are very different. The main reason is that the probabilities are a lot higher for the aggregate model. This makes sense, the binomial probability takes into account all the different ways that x out of 18 trials can occur. That is taken into account by the binomial coefficient.</p>
<p>You’ll also notice that we got <span class="math inline">\(\hat{k}\)</span> warnings. This is because we really aren’t doing LOO-CV anymore. We can be leaving up to 18 points out since the weights are calculated at the <span class="math inline">\((\text{treatment}, \text{actor})\)</span> level. So leaving one out is really like leaving 18 points out. Much more likely for things to be influential in the total model.</p>
<p>Let’s now switch to a instance where we don’t have the same number of trials per data point:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(UCBadmit)</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> UCBadmit</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We want to model the probability of acceptance given an applicants gender:</p>
<p><span class="math display">\[\begin{align}
A &amp;\sim \text{Binomial}(N_i,p_i)\\
\text{logit}(p_i) &amp;= \alpha_{\text{GID[i]}}\\
\alpha_j &amp;\sim \text{Normal}(0,1.5)\\
\end{align}\]</span></p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>dat_list <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">admit =</span> d<span class="sc">$</span>admit,</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">applications =</span> d<span class="sc">$</span>applications,</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">gid =</span> <span class="fu">ifelse</span>(d<span class="sc">$</span>applicant.gender <span class="sc">==</span> <span class="st">'male'</span>, <span class="dv">1</span>, <span class="dv">2</span>)</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>m11<span class="fl">.7</span> <span class="ot">&lt;-</span> <span class="fu">ulam</span>(<span class="fu">alist</span>(</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>  admit <span class="sc">~</span> <span class="fu">dbinom</span>(applications, p),</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">logit</span>(p) <span class="ot">&lt;-</span> a[gid],</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>  a[gid] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="fl">1.5</span>)</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>), <span class="at">data=</span>dat_list, <span class="at">chains=</span><span class="dv">4</span>, <span class="at">cores=</span><span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">precis</span>(m11<span class="fl">.7</span>, <span class="at">depth=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>           mean         sd       5.5%      94.5%     rhat ess_bulk
a[1] -0.2194016 0.03977851 -0.2824417 -0.1543282 1.000159 1182.041
a[2] -0.8296256 0.05082731 -0.9078748 -0.7491444 1.004450 1175.208</code></pre>
</div>
</div>
<p>Let’s now calculate the contrast between male and female applicants. We will calculate it on the relative and absolute scale:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>post <span class="ot">&lt;-</span> <span class="fu">extract.samples</span>(m11<span class="fl">.7</span>)</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>diff_a <span class="ot">&lt;-</span> post<span class="sc">$</span>a[,<span class="dv">1</span>] <span class="sc">-</span> post<span class="sc">$</span>a[,<span class="dv">2</span>] </span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>diff_p <span class="ot">&lt;-</span> <span class="fu">inv_logit</span>(post<span class="sc">$</span>a[,<span class="dv">1</span>]) <span class="sc">-</span> <span class="fu">inv_logit</span>(post<span class="sc">$</span>a[,<span class="dv">2</span>])</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="fu">precis</span>(<span class="fu">list</span>(<span class="at">diff_a=</span>diff_a, <span class="at">diff_p=</span>diff_p))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>            mean        sd      5.5%     94.5%   histogram
diff_a 0.6102240 0.0626899 0.5098874 0.7086794   ▁▁▁▃▇▇▃▂▁
diff_p 0.1415584 0.0141332 0.1188481 0.1639834 ▁▁▁▁▃▇▇▅▂▁▁</code></pre>
</div>
</div>
<p>Recall that <code>diff_a</code> is giving us the difference on the log-odds scale, while <code>diff_p</code> is on the absolute scale. So it looks like that being male gives students a 14% higher on average acceptance rate.</p>
<p>Let’s plot some posterior predictive checks:</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">postcheck</span>(m11<span class="fl">.7</span>)</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>){</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">+</span> <span class="dv">2</span><span class="sc">*</span>(i<span class="dv">-1</span>)</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>  y1 <span class="ot">&lt;-</span> d<span class="sc">$</span>admit[x]<span class="sc">/</span>d<span class="sc">$</span>applications[x]</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>  y2 <span class="ot">&lt;-</span> d<span class="sc">$</span>admit[x<span class="sc">+</span><span class="dv">1</span>]<span class="sc">/</span>d<span class="sc">$</span>applications[x<span class="sc">+</span><span class="dv">1</span>]</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(<span class="fu">c</span>(x, x<span class="sc">+</span><span class="dv">1</span>), <span class="fu">c</span>(y1,y2), <span class="at">col=</span>rangi2, <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">text</span>(x <span class="sc">+</span> <span class="fl">0.5</span>, (y1 <span class="sc">+</span> y2)<span class="sc">/</span><span class="dv">2</span> <span class="sc">+</span> <span class="fl">0.05</span>, d<span class="sc">$</span>dept[x], <span class="at">cex=</span><span class="fl">0.8</span>, <span class="at">col=</span>rangi2)</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ch11_files/figure-html/unnamed-chunk-26-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
<p>The vertical <em>lines</em> are the 89% CI for the expected value. The crosses are the 89% simulated samples, and the open points are the posterior mean.</p>
<p>You’ll notice that it isn’t actually the case that male acceptance is higher than female. That is only the case for departments C and E. This is of course a case of Simpson’s Paradox. Women are more likely to apply to departments with lower admission rates like department F:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>d <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(dept) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">overall_acceptance =</span> <span class="fu">sum</span>(admit) <span class="sc">/</span> <span class="fu">sum</span>(applications), </span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">perc_female =</span> <span class="fu">sum</span>(<span class="fu">ifelse</span>(applicant.gender<span class="sc">==</span><span class="st">'female'</span>, applications,<span class="dv">0</span>))<span class="sc">/</span><span class="fu">sum</span>(applications))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 3
  dept  overall_acceptance perc_female
  &lt;fct&gt;              &lt;dbl&gt;       &lt;dbl&gt;
1 A                 0.644       0.116 
2 B                 0.632       0.0427
3 C                 0.351       0.646 
4 D                 0.340       0.473 
5 E                 0.252       0.673 
6 F                 0.0644      0.478 </code></pre>
</div>
</div>
<p>Let’s now fit a model that models the variation between male and female within departments.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>dat_list<span class="sc">$</span>dept_id <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>, <span class="at">each=</span><span class="dv">2</span>)</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>m11<span class="fl">.8</span> <span class="ot">&lt;-</span> <span class="fu">ulam</span>(<span class="fu">alist</span>(</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>  admit <span class="sc">~</span> <span class="fu">dbinom</span>(applications, p),</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">logit</span>(p) <span class="ot">&lt;-</span> a[gid] <span class="sc">+</span> delta[dept_id],</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>  a[gid] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="fl">1.5</span>),</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>  delta[dept_id] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="fl">1.5</span>)</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>), <span class="at">data=</span>dat_list, <span class="at">chains=</span><span class="dv">4</span>, <span class="at">cores=</span><span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">precis</span>(m11<span class="fl">.8</span>, <span class="at">depth=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>                mean        sd       5.5%      94.5%     rhat  ess_bulk
a[1]     -0.59594918 0.5680758 -1.5483165  0.3871614 1.037367  97.86121
a[2]     -0.50014887 0.5736022 -1.4299653  0.4828115 1.037141 102.13404
delta[1]  1.17482007 0.5721352  0.1906398  2.1248605 1.036177 104.45630
delta[2]  1.12940878 0.5728325  0.1534840  2.0412100 1.036488 105.31133
delta[3] -0.08218244 0.5745452 -1.0613944  0.8674434 1.036653 100.63552
delta[4] -0.11485671 0.5730780 -1.1189938  0.8428667 1.036950  98.36651
delta[5] -0.56036854 0.5782627 -1.5440778  0.3717220 1.036610 109.10481
delta[6] -2.11717838 0.5824360 -3.1186261 -1.2107651 1.036415 109.46618</code></pre>
</div>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>post <span class="ot">&lt;-</span> <span class="fu">extract.samples</span>(m11<span class="fl">.8</span>)</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>diff_a <span class="ot">&lt;-</span> post<span class="sc">$</span>a[,<span class="dv">1</span>] <span class="sc">-</span> post<span class="sc">$</span>a[,<span class="dv">2</span>] </span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>diff_p <span class="ot">&lt;-</span> <span class="fu">inv_logit</span>(post<span class="sc">$</span>a[,<span class="dv">1</span>]) <span class="sc">-</span> <span class="fu">inv_logit</span>(post<span class="sc">$</span>a[,<span class="dv">2</span>])</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="fu">precis</span>(<span class="fu">list</span>(<span class="at">diff_a=</span>diff_a, <span class="at">diff_p=</span>diff_p))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>              mean         sd        5.5%       94.5%       histogram
diff_a -0.09580032 0.08187207 -0.22847179 0.038360685    ▁▁▁▂▃▇▇▃▂▁▁▁
diff_p -0.02101334 0.01849849 -0.05143061 0.008110272 ▁▁▁▁▁▂▅▇▇▃▂▁▁▁▁</code></pre>
</div>
</div>
<p>We now see that male applicants might have it <em>worse</em>. But this of course is not a significant effect.</p>
<p>Let’s make a DAG showing our causal graph:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dagitty)</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>dag_m8<span class="fl">.1</span> <span class="ot">&lt;-</span> <span class="fu">dagitty</span>(<span class="st">"dag{</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a><span class="st">  G -&gt; D -&gt; A</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="st">  G -&gt; A</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="st">}"</span>)</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a><span class="fu">coordinates</span>(dag_m8<span class="fl">.1</span>) <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">x=</span><span class="fu">c</span>(<span class="st">'A'</span><span class="ot">=</span><span class="dv">1</span>, <span class="st">'G'</span><span class="ot">=</span><span class="dv">0</span>, <span class="st">'D'</span><span class="ot">=</span><span class="fl">0.5</span>),</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>                              <span class="at">y=</span><span class="fu">c</span>(<span class="st">'A'</span><span class="ot">=</span><span class="dv">0</span>, <span class="st">'G'</span><span class="ot">=</span><span class="dv">0</span>, <span class="st">'D'</span><span class="ot">=</span><span class="sc">-</span><span class="dv">1</span>))</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a><span class="fu">drawdag</span>(dag_m8<span class="fl">.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ch11_files/figure-html/unnamed-chunk-31-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Notice there is an indirect causal path <span class="math inline">\(G \rightarrow D \rightarrow A\)</span>, from gender to acceptance. So we need to condition on <span class="math inline">\(D\)</span> and close the path, which is what model <code>m11.8</code> did.</p>
<p>Recall though, there might be a confounder <span class="math inline">\(U\)</span>:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>dag_m8<span class="fl">.1</span> <span class="ot">&lt;-</span> <span class="fu">dagitty</span>(<span class="st">"dag{</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="st">  U [unobserved]</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="st">  G -&gt; D -&gt; A</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="st">  G -&gt; A</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="st">  D &lt;- U -&gt; A</span></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a><span class="st">}"</span>)</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a><span class="fu">coordinates</span>(dag_m8<span class="fl">.1</span>) <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">x=</span><span class="fu">c</span>(<span class="st">'A'</span><span class="ot">=</span><span class="dv">1</span>, <span class="st">'G'</span><span class="ot">=</span><span class="dv">0</span>, <span class="st">'D'</span><span class="ot">=</span><span class="fl">0.5</span>, <span class="st">'U'</span><span class="ot">=</span><span class="dv">1</span>),</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>                              <span class="at">y=</span><span class="fu">c</span>(<span class="st">'A'</span><span class="ot">=</span><span class="dv">0</span>, <span class="st">'G'</span><span class="ot">=</span><span class="dv">0</span>, <span class="st">'D'</span><span class="ot">=</span><span class="sc">-</span><span class="dv">1</span>, <span class="st">'U'</span> <span class="ot">=</span> <span class="sc">-</span><span class="dv">1</span>))</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a><span class="fu">drawdag</span>(dag_m8<span class="fl">.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ch11_files/figure-html/unnamed-chunk-32-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>If we condition on <span class="math inline">\(D\)</span>, we actually would have <span class="math inline">\(D\)</span> as a collider and open up the non-causal path <span class="math inline">\(G \rightarrow D \leftarrow U \rightarrow A\)</span>.</p>
<p>Going back to model <code>m11.8</code>, it is technically overparameterized. This of course is not a big issue for Bayesian models, so long as we have an adequate sampler that can handle the high correlations. It might be more efficient to instead to use a single parameter that represents the difference between male and female. Richard argues though that this will make one group more uncertain than the other. This of course works itself out on the outcome scale though.</p>
</section>
</section>
<section id="poisson-regression" class="level2">
<h2 class="anchored" data-anchor-id="poisson-regression">11.2 - Poisson Regression</h2>
<p>Let’s look at the skeleton of a Poisson model:</p>
<p><span class="math display">\[\begin{align}
y_i &amp;\sim \text{Poisson}(\lambda_i)\\
\log(\lambda_i) &amp;= \alpha + \beta (x_i - \bar{x})\\
\end{align}\]</span></p>
<p>The data we will start with is that of Oceanic societies and their number of distinct tools:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"Kline"</span>)</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> Kline</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>d</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>      culture population contact total_tools mean_TU
1    Malekula       1100     low          13     3.2
2     Tikopia       1500     low          22     4.7
3  Santa Cruz       3600     low          24     4.0
4         Yap       4791    high          43     5.0
5    Lau Fiji       7400    high          33     5.0
6   Trobriand       8000    high          19     4.0
7       Chuuk       9200    high          40     3.8
8       Manus      13000     low          28     6.6
9       Tonga      17500    high          55     5.4
10     Hawaii     275000     low          71     6.6</code></pre>
</div>
</div>
<p>Let’s look at some the assumptions we would like to bake into our model that predicts <code>total_tools</code>:</p>
<ul>
<li>Number of tools should increase with log population</li>
<li>Islands with more contact will have more tools</li>
<li>We expect the impact of population to be moderated by contact (interactions)</li>
</ul>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>d<span class="sc">$</span>P <span class="ot">&lt;-</span> d<span class="sc">$</span>population <span class="sc">|&gt;</span> <span class="fu">log</span>() <span class="sc">|&gt;</span> <span class="fu">scale</span>()</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>d<span class="sc">$</span>contact_id <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(d<span class="sc">$</span>contact <span class="sc">==</span> <span class="st">'high'</span>, <span class="dv">2</span>, <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><span class="math display">\[\begin{align}
T_i &amp;\sim \text{Poisson}(\lambda_i)\\
\log(\lambda_i) &amp;= \alpha_{\text{CID[i]}} + \beta_{\text{CID[i]}} \log P_i\\
\alpha_j &amp;\sim \text{To be determined} \\
\beta_j &amp;\sim \text{To be determined} \\
\end{align}\]</span></p>
<p>Let’s first try to sniff out the correct priors. We know that <span class="math inline">\(\lambda\)</span> has to be positive, so any prior we put on <span class="math inline">\(\alpha\)</span> will be exponentiated. So if we choose a normal prior with <span class="math inline">\(\sigma=10\)</span>, then <span class="math inline">\(\lambda\)</span> we have a lognormal outcome.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu">curve</span>(<span class="fu">dlnorm</span>(x, <span class="dv">0</span>, <span class="dv">10</span>), <span class="dv">0</span>, <span class="dv">100</span>, <span class="at">n=</span><span class="dv">200</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ch11_files/figure-html/unnamed-chunk-35-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Now, this tail is <em>very</em> long. So long in fact that the mean of the distribution above is:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(<span class="fu">rlnorm</span>(<span class="fl">1e4</span>, <span class="dv">0</span>,<span class="dv">10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 7.696734e+14</code></pre>
</div>
</div>
<p>Something to keep in mind is that the log link puts all the negative between 0 and 1 on the outcome scale. That means that if half of our prior mass is below 0, then half of the outcome will be between 0 and 1.</p>
<p>Let’s instead try something a bit more sensible:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">curve</span>(<span class="fu">dlnorm</span>(x, <span class="dv">3</span>, <span class="fl">0.5</span>), <span class="dv">0</span>, <span class="dv">100</span>, <span class="at">n=</span><span class="dv">200</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ch11_files/figure-html/unnamed-chunk-37-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(<span class="fu">rlnorm</span>(<span class="fl">1e5</span>, <span class="dv">3</span>, <span class="fl">0.5</span>)) <span class="sc">|&gt;</span> <span class="fu">print</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 22.7135</code></pre>
</div>
</div>
<p>We now need to come up with something sensible for <span class="math inline">\(\beta\)</span>. Let’s again try <span class="math inline">\(N(0,10)\)</span> and see what happens to the outcome:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N, <span class="dv">3</span>, <span class="fl">0.5</span>)</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N, <span class="dv">0</span>, <span class="dv">10</span>)</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="cn">NULL</span>, <span class="at">xlim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">2</span>,<span class="dv">2</span>), <span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">100</span>))</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) <span class="fu">curve</span>(<span class="fu">exp</span>(a[i] <span class="sc">+</span> b[i]<span class="sc">*</span>x), <span class="at">add=</span>T, <span class="at">col=</span><span class="fu">grau</span>(), <span class="at">xlab=</span><span class="st">'x'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ch11_files/figure-html/unnamed-chunk-38-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The pivoting around 0 is just the mean outcome for the average log population (approx. 22). What’s interesting is that model thinks that just above or below the mean the outcome variable either goes to zero or blows up! Nothing in-between.</p>
<p>Something better might be:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N, <span class="dv">3</span>, <span class="fl">0.5</span>)</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N, <span class="dv">0</span>, <span class="fl">0.2</span>)</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="cn">NULL</span>, <span class="at">xlim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">2</span>,<span class="dv">2</span>), <span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">100</span>))</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) <span class="fu">curve</span>(<span class="fu">exp</span>(a[i] <span class="sc">+</span> b[i]<span class="sc">*</span>x), <span class="at">add=</span>T, <span class="at">col=</span><span class="fu">grau</span>(), <span class="at">xlab=</span><span class="st">'x'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ch11_files/figure-html/unnamed-chunk-39-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Hmm, a little too tight. Almost on relationship now between log population and tools.</p>
<p>Let’s look at this a different way - instead of the z-score, let’s keep population unstandardized:</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>x_seq <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fu">log</span>(<span class="dv">100</span>), <span class="fu">log</span>(<span class="fl">2e5</span>), <span class="at">length.out=</span><span class="dv">105</span>)</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>lambda <span class="ot">&lt;-</span> <span class="fu">vapply</span>(x_seq, \(x) <span class="fu">exp</span>(a <span class="sc">+</span> b<span class="sc">*</span>x), <span class="fu">numeric</span>(N))</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="cn">NULL</span>, <span class="at">xlim=</span><span class="fu">range</span>(x_seq), <span class="at">ylim=</span><span class="fu">range</span>(lambda), <span class="at">xlab=</span><span class="st">'log pop'</span>, <span class="at">ylab=</span><span class="st">'total tools'</span>)</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) <span class="fu">lines</span>(x_seq, lambda[i,], <span class="at">col=</span><span class="fu">grau</span>(), <span class="at">lwd=</span><span class="fl">1.5</span>)</span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="cn">NULL</span>, <span class="at">xlim=</span><span class="fu">range</span>(<span class="fu">exp</span>(x_seq)), <span class="at">ylim=</span><span class="fu">range</span>(lambda), <span class="at">xlab=</span><span class="st">'Population'</span>, <span class="at">ylab=</span><span class="st">'total tools'</span>)</span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) <span class="fu">lines</span>(<span class="fu">exp</span>(x_seq), lambda[i,], <span class="at">col=</span><span class="fu">grau</span>(), <span class="at">lwd=</span><span class="fl">1.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ch11_files/figure-html/unnamed-chunk-40-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
<p>Notice that the left plot we be linear if we logged it. This also shows why it is usually better to log the covariate. We want to imply that there are diminishing returns for adding population at higher values. It means more to add a couple people when the population is very low than compared to when it is high.</p>
<p>We can now go ahead and build our models. We will fit an intercept only model as well as the full model:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">T =</span> d<span class="sc">$</span>total_tools,</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">P =</span> d<span class="sc">$</span>P,</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">cid =</span> d<span class="sc">$</span>contact_id</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a><span class="co"># intercept only</span></span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>m11<span class="fl">.9</span> <span class="ot">&lt;-</span> <span class="fu">ulam</span>(<span class="fu">alist</span>(</span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>  T <span class="sc">~</span> <span class="fu">dpois</span>(lambda),</span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">log</span>(lambda) <span class="ot">&lt;-</span> a,</span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>  a <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">3</span>, <span class="fl">0.5</span>)</span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a>), <span class="at">data=</span>dat, <span class="at">chains=</span><span class="dv">4</span>, <span class="at">cores=</span><span class="dv">4</span>, <span class="at">log_lik =</span> <span class="cn">TRUE</span>)</span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a><span class="co"># full model</span></span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true" tabindex="-1"></a>m11<span class="fl">.10</span> <span class="ot">&lt;-</span> <span class="fu">ulam</span>(<span class="fu">alist</span>(</span>
<span id="cb62-16"><a href="#cb62-16" aria-hidden="true" tabindex="-1"></a>  T <span class="sc">~</span> <span class="fu">dpois</span>(lambda),</span>
<span id="cb62-17"><a href="#cb62-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">log</span>(lambda) <span class="ot">&lt;-</span> a[cid] <span class="sc">+</span> b[cid]<span class="sc">*</span>P,</span>
<span id="cb62-18"><a href="#cb62-18" aria-hidden="true" tabindex="-1"></a>  a[cid] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">3</span>, <span class="fl">0.5</span>),</span>
<span id="cb62-19"><a href="#cb62-19" aria-hidden="true" tabindex="-1"></a>  b[cid] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>, <span class="fl">0.2</span>)</span>
<span id="cb62-20"><a href="#cb62-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-21"><a href="#cb62-21" aria-hidden="true" tabindex="-1"></a>), <span class="at">data=</span>dat, <span class="at">chains=</span><span class="dv">4</span>, <span class="at">cores=</span><span class="dv">4</span>, <span class="at">log_lik=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="fu">compare</span>(m11<span class="fl">.9</span>, m11<span class="fl">.10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>            WAIC       SE    dWAIC    dSE    pWAIC       weight
m11.10  84.16892 12.47027  0.00000     NA 6.452128 1.000000e+00
m11.9  141.03615 31.92049 56.86723 33.831 7.840635 4.481654e-13</code></pre>
</div>
</div>
<p>Notice that model <code>m11.10</code> actually has fewer number of effective parameters. This is surprising since we actually have 3 net new parameters in model <code>m11.10</code>. But, recall that we can really only think about effective parameters and parameter count relationship in simple linear models. We know that parameter values near boundaries produce less overfitting and therefore contribute less to effective number of parameters. This is true about bounded data too. See that a large amount of the bounds are bounded by population not able to be negative, so introducing this covariate actually reduces the number of effective parameters since it limits the parameter space inadvertently.</p>
<p>Let’s go ahead and plot the posterior predictive space:</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>K <span class="ot">&lt;-</span> <span class="fu">PSIS</span>(m11<span class="fl">.10</span>, <span class="at">pointwise =</span> T)<span class="sc">$</span>k</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Some Pareto k values are high (&gt;0.5). Set pointwise=TRUE to inspect individual points.</code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(dat<span class="sc">$</span>P, dat<span class="sc">$</span>T, <span class="at">xlab=</span><span class="st">'log pop (std.)'</span>, <span class="at">ylab=</span><span class="st">'tools'</span>, <span class="at">col=</span>rangi2, </span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>     <span class="at">pch=</span><span class="fu">ifelse</span>(dat<span class="sc">$</span>cid <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">16</span>), <span class="at">lwd=</span><span class="dv">2</span>, <span class="at">cex=</span><span class="dv">1</span><span class="sc">+</span><span class="fu">normalize</span>(K))</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>ns <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>p_seq <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="fl">1.4</span>, <span class="fu">max</span>(dat<span class="sc">$</span>P), <span class="at">length.out=</span>ns)</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>){</span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>  lambda <span class="ot">&lt;-</span> <span class="fu">link</span>(m11<span class="fl">.10</span>, <span class="at">data=</span><span class="fu">data.frame</span>(<span class="at">P=</span>p_seq, <span class="at">cid=</span>i))</span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a>  lmu <span class="ot">&lt;-</span> <span class="fu">colMeans</span>(lambda)</span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a>  lci <span class="ot">&lt;-</span> <span class="fu">apply</span>(lambda, <span class="dv">2</span>, PI)</span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(p_seq, lmu, <span class="at">lty=</span><span class="fu">ifelse</span>(i<span class="sc">==</span><span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">1</span>), <span class="at">lwd=</span><span class="fl">1.5</span>)</span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">shade</span>(lci, p_seq, <span class="at">xpd=</span>T)</span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb67-14"><a href="#cb67-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-15"><a href="#cb67-15" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(d<span class="sc">$</span>population, d<span class="sc">$</span>total_tools, <span class="at">xlab=</span><span class="st">'pop'</span>, <span class="at">ylab=</span><span class="st">'tools'</span>,</span>
<span id="cb67-16"><a href="#cb67-16" aria-hidden="true" tabindex="-1"></a>     <span class="at">col=</span>rangi2, <span class="at">pch=</span><span class="fu">ifelse</span>(dat<span class="sc">$</span>cid <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">16</span>), <span class="at">lwd=</span><span class="dv">2</span>,</span>
<span id="cb67-17"><a href="#cb67-17" aria-hidden="true" tabindex="-1"></a>     <span class="at">cex=</span><span class="dv">1</span> <span class="sc">+</span> <span class="fu">normalize</span>(K))</span>
<span id="cb67-18"><a href="#cb67-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-19"><a href="#cb67-19" aria-hidden="true" tabindex="-1"></a>ns <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb67-20"><a href="#cb67-20" aria-hidden="true" tabindex="-1"></a>p_seq <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="fl">1.4</span>, <span class="fu">max</span>(dat<span class="sc">$</span>P), <span class="at">length.out=</span>ns)</span>
<span id="cb67-21"><a href="#cb67-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Need to convert back to non standard (add mean and multilpy by sd of log pop)</span></span>
<span id="cb67-22"><a href="#cb67-22" aria-hidden="true" tabindex="-1"></a>pop_seq <span class="ot">&lt;-</span> <span class="fu">exp</span>(p_seq<span class="sc">*</span><span class="fl">1.53</span> <span class="sc">+</span> <span class="dv">9</span>)</span>
<span id="cb67-23"><a href="#cb67-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-24"><a href="#cb67-24" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>){</span>
<span id="cb67-25"><a href="#cb67-25" aria-hidden="true" tabindex="-1"></a>  lambda <span class="ot">&lt;-</span> <span class="fu">link</span>(m11<span class="fl">.10</span>, <span class="at">data=</span><span class="fu">data.frame</span>(<span class="at">P=</span>p_seq, <span class="at">cid=</span>i))</span>
<span id="cb67-26"><a href="#cb67-26" aria-hidden="true" tabindex="-1"></a>  lmu <span class="ot">&lt;-</span> <span class="fu">colMeans</span>(lambda)</span>
<span id="cb67-27"><a href="#cb67-27" aria-hidden="true" tabindex="-1"></a>  lci <span class="ot">&lt;-</span> <span class="fu">apply</span>(lambda, <span class="dv">2</span>, PI)</span>
<span id="cb67-28"><a href="#cb67-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(pop_seq, lmu, <span class="at">lty=</span><span class="fu">ifelse</span>(i<span class="sc">==</span><span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">1</span>), <span class="at">lwd=</span><span class="fl">1.5</span>)</span>
<span id="cb67-29"><a href="#cb67-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">shade</span>(lci, pop_seq, <span class="at">xpd=</span>T)</span>
<span id="cb67-30"><a href="#cb67-30" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ch11_files/figure-html/unnamed-chunk-43-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
<p>Hawaii is the point in the top right of the right graph. Clearly, because of its very large population, it is highly influential and is therefore contributing to the high <span class="math inline">\(\hat{k}\)</span>.</p>
<p>Now, notice that the trend for high contact societies (solid) is higher than that of low contact societies (dashed). But, notice that the model is allowing that past a certain population size, the relationship flips and low contact becomes higher expected than high contact. Of course, a counterfactual of Hawaii with low contact shouldn’t be higher than current Hawaii.</p>
<p>Also, notice that sine we have given the model the intercept as a free parameter, it can be the case where will will have a non-zero number of expected tools when the population is zero. This can never be possible!</p>
<p>We could combat this by coming up with an ecology informed formula. The implementation is at the top of page 356.</p>
<section id="negative-binomial" class="level3">
<h3 class="anchored" data-anchor-id="negative-binomial">11.2.2 Negative Binomial</h3>
<p>It is sometimes important to allow for extra variation beyond just assuming the variance is equal to <span class="math inline">\(\lambda\)</span>. This would lead us to the Negative Binomial, or sometimes called the Gamma-Poisson. It is really just a Poisson in disguise since it is a mixture of many Poisson distributions (gamma is the mixing distribution and <span class="math inline">\(\lambda\)</span> is Gamma distributed). It is analagous to the student-t distribution which is a mixture of normals where <span class="math inline">\(\sigma^2\)</span> follows an inverse gamma.</p>
</section>
<section id="exposure-and-offset" class="level3">
<h3 class="anchored" data-anchor-id="exposure-and-offset">11.2.3 Exposure and Offset</h3>
<p>The parameter <span class="math inline">\(\lambda\)</span> is the expected number of events, but it can also be thought of as a rate. Implicitly, <span class="math inline">\(\lambda = \mu/\tau\)</span>, the expected number of events <span class="math inline">\(\mu\)</span> per unit time or distance <span class="math inline">\(\tau\)</span>. We can then redefine our model as:</p>
<p><span class="math display">\[\begin{align}
y_i &amp;\sim \text{Poisson}(\lambda_i)\\
\log \lambda_i &amp;= \log \frac{\mu_i}{\tau_i} = \alpha + \beta x_i\\
\end{align}\]</span></p>
<p>We can then use some log math to show <span class="math inline">\(\log \lambda_i = \log \mu_i = \log \tau_i + \alpha + \beta x_i\)</span>.</p>
<p>Notice when <span class="math inline">\(\tau_i = 1\)</span> then we are left with the same equation we’ve been using the whole time. But, if <span class="math inline">\(\tau_i\)</span> does change we are effectively just adding another covariate (<span class="math inline">\(\log \tau_i\)</span>) to our linear equation. BUT, there is no coefficient for this covariate - it is just a raw addition value.</p>
<p>Our model then effectively becomes:</p>
<p><span class="math display">\[\begin{align}
y_i &amp;\sim \text{Poisson}(\mu_i)\\
\log \mu_i &amp;= \log \tau_i + \alpha + \beta x_i\\
\end{align}\]</span></p>
<p>This <span class="math inline">\(\log \tau_i\)</span> column is also called the <strong>offset</strong>.</p>
<p>Let’s simulate some data:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="co"># monastery 1</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>num_days <span class="ot">&lt;-</span> <span class="dv">30</span></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">rpois</span>(num_days, <span class="fl">1.5</span>)</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a><span class="co"># monastery 2 - measured on a weekly basis but lower daily rate</span></span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>num_weeks <span class="ot">&lt;-</span> <span class="dv">4</span></span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>y_new <span class="ot">&lt;-</span> <span class="fu">rpois</span>(num_weeks, <span class="fl">0.5</span><span class="sc">*</span><span class="dv">7</span>)</span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>y_all <span class="ot">&lt;-</span> <span class="fu">c</span>(y, y_new)</span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a>exposure <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">1</span>,<span class="dv">30</span>), <span class="fu">rep</span>(<span class="dv">7</span>,<span class="dv">4</span>))</span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a>monastery <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">0</span>,<span class="dv">30</span>), <span class="fu">rep</span>(<span class="dv">1</span>,<span class="dv">4</span>))</span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">y=</span>y_all, <span class="at">days=</span>exposure, <span class="at">monastery=</span>monastery)</span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a>d<span class="sc">$</span>log_days <span class="ot">&lt;-</span> <span class="fu">log</span>(d<span class="sc">$</span>days)</span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true" tabindex="-1"></a>m11<span class="fl">.12</span> <span class="ot">&lt;-</span> <span class="fu">quap</span>(<span class="fu">alist</span>(</span>
<span id="cb68-16"><a href="#cb68-16" aria-hidden="true" tabindex="-1"></a>  y <span class="sc">~</span> <span class="fu">dpois</span>(lambda),</span>
<span id="cb68-17"><a href="#cb68-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">log</span>(lambda) <span class="ot">&lt;-</span> log_days <span class="sc">+</span> a <span class="sc">+</span> b<span class="sc">*</span>monastery,</span>
<span id="cb68-18"><a href="#cb68-18" aria-hidden="true" tabindex="-1"></a>  a <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb68-19"><a href="#cb68-19" aria-hidden="true" tabindex="-1"></a>  b <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb68-20"><a href="#cb68-20" aria-hidden="true" tabindex="-1"></a>), <span class="at">data=</span>d)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>When we extract the predictions, everything is already on the daily scale so we don’t need to make any adjustments.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>post <span class="ot">&lt;-</span> <span class="fu">extract.samples</span>(m11<span class="fl">.12</span>)</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>lambda_old <span class="ot">&lt;-</span> <span class="fu">exp</span>(post<span class="sc">$</span>a)</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>lambda_new <span class="ot">&lt;-</span> <span class="fu">exp</span>(post<span class="sc">$</span>a <span class="sc">+</span> post<span class="sc">$</span>b)</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a><span class="fu">precis</span>(<span class="fu">data.frame</span>(lambda_old, lambda_new))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>                mean        sd     5.5%     94.5%  histogram
lambda_old 1.8087008 0.2440873 1.440772 2.2173040 ▁▁▃▇▇▃▁▁▁▁
lambda_new 0.3934154 0.1187825 0.234139 0.6030955 ▁▃▇▅▂▁▁▁▁▁</code></pre>
</div>
</div>
<p>The parameters are about right with what we simulated.</p>
</section>
</section>
<section id="multinomial-and-categorical-models" class="level2">
<h2 class="anchored" data-anchor-id="multinomial-and-categorical-models">11.3 - Multinomial and categorical models</h2>
<p>When more than two types of events are possible, and the probability of each type of event is constant and unordered, then the maximum entropy distribution is a multinomial distribution. The pdf is defined as:</p>
<p><span class="math display">\[P(y_1, \dots. y_K|n, p_1, \dots, p_K) = \frac{n!}{\prod_i y_i!} \prod^K_{i=1}p_i^{y_i}\]</span></p>
<p>Where <span class="math inline">\(K\)</span> is the unique number of events, and <span class="math inline">\(y_i\)</span> is the number of events of type <span class="math inline">\(i\)</span> out of <span class="math inline">\(n\)</span> trials. A model with this likelihood is sometimes referred to as <strong>categorical regression</strong>. There are two approachs we are going to use to specify the model. The <em>explicit</em> approach uses the multinomial logit, aka the softmax as the link:</p>
<p><span class="math display">\[P(k|s_1, \dots, s_K) = \frac{\exp(s_k)}{\sum_{i=1}^K\exp(s_i)}\]</span> The scores here are of course continuous. For multinomial logistic regression we need <span class="math inline">\(K-1\)</span> models. One of the outcome variables will be our pivot variable. This of course keeps us from having an overdetermined system of equations.</p>
<section id="predictors-matched-to-outcomes" class="level3">
<h3 class="anchored" data-anchor-id="predictors-matched-to-outcomes">11.3.1 Predictors matched to outcomes</h3>
<p>Let’s simulate career choices for young adults:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">500</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>income <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">5</span>)</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>score <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>income</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">softmax</span>(score)</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>career <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, N)</span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">34302</span>)</span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) career[i] <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">size=</span><span class="dv">1</span>, <span class="at">prob=</span>p)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Let’s now fit the model with stan code:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>code_m11<span class="fl">.13</span> <span class="ot">&lt;-</span> <span class="st">"</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a><span class="st">data{</span></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a><span class="st">   int N;</span></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a><span class="st">   int K;</span></span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a><span class="st">   array[N] int career;</span></span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a><span class="st">   vector[K] career_income;</span></span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a><span class="st">parameters{</span></span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[K-1] a; // intercepts</span></span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0&gt; b; // association of income with choice</span></span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a><span class="st">model{</span></span>
<span id="cb72-13"><a href="#cb72-13" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[K] p;</span></span>
<span id="cb72-14"><a href="#cb72-14" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[K] s;</span></span>
<span id="cb72-15"><a href="#cb72-15" aria-hidden="true" tabindex="-1"></a><span class="st">  a ~ normal(0, 1);</span></span>
<span id="cb72-16"><a href="#cb72-16" aria-hidden="true" tabindex="-1"></a><span class="st">  b ~ normal(0, 0.5);</span></span>
<span id="cb72-17"><a href="#cb72-17" aria-hidden="true" tabindex="-1"></a><span class="st">  s[1] = a[1] + b*career_income[1];</span></span>
<span id="cb72-18"><a href="#cb72-18" aria-hidden="true" tabindex="-1"></a><span class="st">  s[2] = a[2] + b*career_income[2];</span></span>
<span id="cb72-19"><a href="#cb72-19" aria-hidden="true" tabindex="-1"></a><span class="st">  s[3] = 0; // pivot </span></span>
<span id="cb72-20"><a href="#cb72-20" aria-hidden="true" tabindex="-1"></a><span class="st">  p = softmax(s);</span></span>
<span id="cb72-21"><a href="#cb72-21" aria-hidden="true" tabindex="-1"></a><span class="st">  career ~ categorical(p);</span></span>
<span id="cb72-22"><a href="#cb72-22" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb72-23"><a href="#cb72-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-24"><a href="#cb72-24" aria-hidden="true" tabindex="-1"></a><span class="st">"</span></span>
<span id="cb72-25"><a href="#cb72-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-26"><a href="#cb72-26" aria-hidden="true" tabindex="-1"></a>dat_list <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">N=</span>N, <span class="at">K=</span><span class="dv">3</span>, <span class="at">career=</span>career, <span class="at">career_income=</span>income)</span>
<span id="cb72-27"><a href="#cb72-27" aria-hidden="true" tabindex="-1"></a>m11<span class="fl">.13</span> <span class="ot">&lt;-</span> <span class="fu">stan</span>(<span class="at">model_code=</span>code_m11<span class="fl">.13</span>, <span class="at">data=</span>dat_list, <span class="at">chains=</span><span class="dv">4</span>, <span class="at">cores=</span><span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="fu">precis</span>(m11<span class="fl">.13</span>, <span class="at">depth=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>           mean        sd         5.5%      94.5%     rhat ess_bulk
a[1] -2.1554217 0.1984598 -2.480383450 -1.8546568 1.004042 421.8194
a[2] -1.8225057 0.2829974 -2.366039700 -1.4588273 1.004365 359.6091
b     0.1470934 0.1283186  0.007986523  0.3917914 1.005056 295.8366</code></pre>
</div>
</div>
<p>It is clear that <code>b</code> is positive, but we don’t know how it actually effects the outcome. This is why we always need to convert to the outcome scale.</p>
<p>Let’s make a counterfactual - what would happen if we double the income of a career, specifically career 2:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>post <span class="ot">&lt;-</span> <span class="fu">extract.samples</span>(m11<span class="fl">.13</span>)</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>s1 <span class="ot">&lt;-</span> <span class="fu">with</span>(post, a[,<span class="dv">1</span>] <span class="sc">+</span> b<span class="sc">*</span>income[<span class="dv">1</span>])</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>s2_orig <span class="ot">&lt;-</span> <span class="fu">with</span>(post, a[,<span class="dv">2</span>] <span class="sc">+</span> b<span class="sc">*</span>income[<span class="dv">2</span>])</span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>s2_new <span class="ot">&lt;-</span> <span class="fu">with</span>(post, a[,<span class="dv">2</span>] <span class="sc">+</span> b<span class="sc">*</span>income[<span class="dv">2</span>]<span class="sc">*</span><span class="dv">2</span>)</span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a>p_orig <span class="ot">&lt;-</span> <span class="fu">vapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(post<span class="sc">$</span>b), \(x) <span class="fu">softmax</span>(s1[x], s2_orig[x], <span class="dv">0</span>), <span class="fu">numeric</span>(<span class="dv">3</span>)) <span class="sc">|&gt;</span> <span class="fu">t</span>()</span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a>p_new <span class="ot">&lt;-</span> <span class="fu">vapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(post<span class="sc">$</span>b), \(x) <span class="fu">softmax</span>(s1[x], s2_new[x], <span class="dv">0</span>), <span class="fu">numeric</span>(<span class="dv">3</span>)) <span class="sc">|&gt;</span> <span class="fu">t</span>()</span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a><span class="fu">precis</span>(p_new[,<span class="dv">2</span>] <span class="sc">-</span> p_orig[,<span class="dv">2</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>                               mean         sd        5.5%     94.5%
p_new...2....p_orig...2. 0.04686487 0.04567787 0.002196679 0.1324887
                              histogram
p_new...2....p_orig...2. ▇▃▂▂▁▁▁▁▁▁▁▁▁▁</code></pre>
</div>
</div>
<p>So about a 5 point increase for doubling the income. Notice, that value is conditional on comparing to the other careers.</p>
</section>
<section id="predictors-matched-to-observations" class="level3">
<h3 class="anchored" data-anchor-id="predictors-matched-to-observations">11.3.1 Predictors matched to observations</h3>
<p>Suppose now that we want to incorporate family income into the model. The difference here is that the predictor variable (family income), must have the same value for each linear model.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">500</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>family_income <span class="ot">&lt;-</span> <span class="fu">runif</span>(N)</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">2</span>,<span class="dv">0</span>,<span class="dv">2</span>)</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>career <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, N)</span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N){</span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a>  score <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>) <span class="sc">+</span> b<span class="sc">*</span>family_income[i]</span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="fu">softmax</span>(score)</span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a>  career[i] <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">size=</span><span class="dv">1</span>, <span class="at">prob=</span>p)</span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Now the stan code:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>code_m11<span class="fl">.14</span> <span class="ot">&lt;-</span> <span class="st">"</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a><span class="st">data{</span></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a><span class="st">   int N;</span></span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a><span class="st">   int K;</span></span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a><span class="st">   array[N] int career;</span></span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a><span class="st">   vector[N] family_income;</span></span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a><span class="st">parameters{</span></span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[K-1] a; // intercepts</span></span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[K-1] b; // coeff for family income</span></span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb78-12"><a href="#cb78-12" aria-hidden="true" tabindex="-1"></a><span class="st">model{</span></span>
<span id="cb78-13"><a href="#cb78-13" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[K] p;</span></span>
<span id="cb78-14"><a href="#cb78-14" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[K] s;</span></span>
<span id="cb78-15"><a href="#cb78-15" aria-hidden="true" tabindex="-1"></a><span class="st">  a ~ normal(0, 1.5);</span></span>
<span id="cb78-16"><a href="#cb78-16" aria-hidden="true" tabindex="-1"></a><span class="st">  b ~ normal(0, 1);</span></span>
<span id="cb78-17"><a href="#cb78-17" aria-hidden="true" tabindex="-1"></a><span class="st">  for (i in 1:N){</span></span>
<span id="cb78-18"><a href="#cb78-18" aria-hidden="true" tabindex="-1"></a><span class="st">    for (j in 1:(K-1)) s[j] = a[j] + b[j] * family_income[i];</span></span>
<span id="cb78-19"><a href="#cb78-19" aria-hidden="true" tabindex="-1"></a><span class="st">    s[K] = 0; // pivot</span></span>
<span id="cb78-20"><a href="#cb78-20" aria-hidden="true" tabindex="-1"></a><span class="st">    p = softmax(s);</span></span>
<span id="cb78-21"><a href="#cb78-21" aria-hidden="true" tabindex="-1"></a><span class="st">    career[i] ~ categorical(p);</span></span>
<span id="cb78-22"><a href="#cb78-22" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb78-23"><a href="#cb78-23" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb78-24"><a href="#cb78-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-25"><a href="#cb78-25" aria-hidden="true" tabindex="-1"></a><span class="st">"</span></span>
<span id="cb78-26"><a href="#cb78-26" aria-hidden="true" tabindex="-1"></a>dat_list <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">N=</span>N, <span class="at">K=</span><span class="dv">3</span>, <span class="at">career=</span>career, <span class="at">family_income=</span>family_income)</span>
<span id="cb78-27"><a href="#cb78-27" aria-hidden="true" tabindex="-1"></a>m11<span class="fl">.14</span> <span class="ot">&lt;-</span> <span class="fu">stan</span>(<span class="at">model_code=</span>code_m11<span class="fl">.14</span>, <span class="at">data=</span>dat_list, <span class="at">chains=</span><span class="dv">4</span>, <span class="at">cores=</span><span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="fu">precis</span>(m11<span class="fl">.14</span>, <span class="at">depth=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>           mean        sd       5.5%      94.5%     rhat  ess_bulk
a[1] -1.5135065 0.2933859 -1.9788949 -1.0536905 1.001381  981.9375
a[2] -0.4682885 0.2011464 -0.7825174 -0.1351792 1.003178  844.4821
b[1] -2.2620815 0.5787784 -3.2184208 -1.3681182 1.003879 1002.9225
b[2] -1.8617391 0.3853975 -2.5155083 -1.2617806 1.003401  878.0378</code></pre>
</div>
</div>
<p>Again, we can’t look at those coefficients in a vacuum. We need to convert to the outcome scale.</p>
</section>
<section id="multinomial-in-disguise-as-poisson" class="level3">
<h3 class="anchored" data-anchor-id="multinomial-in-disguise-as-poisson">11.3.2 Multinomial in disguise as Poisson</h3>
<p>Let’s start with a simple binomial problem, since a binomial is a special case of the multinomial:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"UCBadmit"</span>)</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> UCBadmit</span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>m_binom <span class="ot">&lt;-</span> <span class="fu">quap</span>(<span class="fu">alist</span>(</span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>  admit <span class="sc">~</span> <span class="fu">dbinom</span>(applications, p),</span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">logit</span>(p) <span class="ot">&lt;-</span> a,</span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a>  a <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>, <span class="fl">1.5</span>)</span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a>), <span class="at">data=</span>d)</span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Poisson model of overall admission rate and rejection rate</span></span>
<span id="cb81-11"><a href="#cb81-11" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">admit=</span>d<span class="sc">$</span>admit, <span class="at">rej=</span>d<span class="sc">$</span>reject)</span>
<span id="cb81-12"><a href="#cb81-12" aria-hidden="true" tabindex="-1"></a>m_pois <span class="ot">&lt;-</span> <span class="fu">ulam</span>(<span class="fu">alist</span>(</span>
<span id="cb81-13"><a href="#cb81-13" aria-hidden="true" tabindex="-1"></a>  admit <span class="sc">~</span> <span class="fu">dpois</span>(lambda1),</span>
<span id="cb81-14"><a href="#cb81-14" aria-hidden="true" tabindex="-1"></a>  rej <span class="sc">~</span> <span class="fu">dpois</span>(lambda2),</span>
<span id="cb81-15"><a href="#cb81-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">log</span>(lambda1) <span class="ot">&lt;-</span> a1,</span>
<span id="cb81-16"><a href="#cb81-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">log</span>(lambda2) <span class="ot">&lt;-</span> a2,</span>
<span id="cb81-17"><a href="#cb81-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(a1, a2) <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>, <span class="fl">1.5</span>)</span>
<span id="cb81-18"><a href="#cb81-18" aria-hidden="true" tabindex="-1"></a>), <span class="at">data=</span>dat, <span class="at">chains=</span><span class="dv">4</span>, <span class="at">cores=</span><span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Let’s look at the posterior means for simplicity:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="fu">inv_logit</span>(<span class="fu">coef</span>(m_binom))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>        a 
0.3878044 </code></pre>
</div>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>k <span class="ot">&lt;-</span> <span class="fu">coef</span>(m_pois)</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>a1 <span class="ot">&lt;-</span> k[<span class="st">'a1'</span>]; a2 <span class="ot">&lt;-</span> k[<span class="st">'a2'</span>]</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a><span class="fu">exp</span>(a1)<span class="sc">/</span>(<span class="fu">exp</span>(a2) <span class="sc">+</span> <span class="fu">exp</span>(a1)) <span class="co"># softmax</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>       a1 
0.3877135 </code></pre>
</div>
</div>
</section>
</section>
<section id="excersises" class="level2">
<h2 class="anchored" data-anchor-id="excersises">Excersises</h2>
<section id="m5" class="level3">
<h3 class="anchored" data-anchor-id="m5">M5</h3>
<p>If we use the logit link for the mean of a Poisson, that would imply that we want the mean of the Poisson, <span class="math inline">\(\lambda\)</span>, to be between 0 and 1. We might use this for any process that we have prior knowledge that on average produces less than 1 unit per time period. Could be some high half life decaying element where we only see emissions at very low rates.</p>
</section>
<section id="h2" class="level3">
<h3 class="anchored" data-anchor-id="h2">H2</h3>
<section id="a" class="level4">
<h4 class="anchored" data-anchor-id="a">a</h4>
<p>For this question we will look at Bald Eagles and their attempts to steal other eagle’s food sources. We want to model the probability of a successful stealing attempt from a “victim” eagle.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MASS)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'MASS'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:dplyr':

    select</code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"eagles"</span>)</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> eagles</span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>d<span class="sc">$</span>P_ind <span class="ot">&lt;-</span> (<span class="fu">as.character</span>(d<span class="sc">$</span>P) <span class="sc">==</span> <span class="st">'L'</span>) <span class="sc">|&gt;</span> <span class="fu">as.integer</span>()</span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>d<span class="sc">$</span>A_ind <span class="ot">&lt;-</span> (<span class="fu">as.character</span>(d<span class="sc">$</span>A) <span class="sc">==</span> <span class="st">'A'</span>) <span class="sc">|&gt;</span> <span class="fu">as.integer</span>()</span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a>d<span class="sc">$</span>V_ind <span class="ot">&lt;-</span> (<span class="fu">as.character</span>(d<span class="sc">$</span>V) <span class="sc">==</span> <span class="st">'L'</span>) <span class="sc">|&gt;</span> <span class="fu">as.integer</span>()</span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(d)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>'data.frame':   8 obs. of  8 variables:
 $ y    : int  17 29 17 20 1 15 0 1
 $ n    : int  24 29 27 20 12 16 28 4
 $ P    : Factor w/ 2 levels "L","S": 1 1 1 1 2 2 2 2
 $ A    : Factor w/ 2 levels "A","I": 1 1 2 2 1 1 2 2
 $ V    : Factor w/ 2 levels "L","S": 1 2 1 2 1 2 1 2
 $ P_ind: int  1 1 1 1 0 0 0 0
 $ A_ind: int  1 1 0 0 1 1 0 0
 $ V_ind: int  1 0 1 0 1 0 1 0</code></pre>
</div>
</div>
<p>Here <span class="math inline">\(y\)</span> is the number of successful attempts out of <span class="math inline">\(n\)</span> trials. <span class="math inline">\(P\)</span> is a dummy variable indicating if the thief eagle has a large body size. <span class="math inline">\(V\)</span> is the same, but for the victim eagle. <span class="math inline">\(A\)</span> is an indicator for if the thief eagle is an adult.</p>
<p>Let’s fit a simply Binomial GLM using the <code>ulam</code> and <code>quap</code> inference methods.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>mod_list <span class="ot">&lt;-</span> <span class="fu">alist</span>(</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>  y <span class="sc">~</span> <span class="fu">dbinom</span>(n, p),</span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">logit</span>(p) <span class="ot">&lt;-</span> alpha <span class="sc">+</span> b_P<span class="sc">*</span>P_ind <span class="sc">+</span> b_A<span class="sc">*</span>A_ind <span class="sc">+</span> b_V<span class="sc">*</span>V_ind,</span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a>  alpha <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="fl">1.5</span>),</span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(b_P, b_A, b_V) <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="fl">0.5</span>)</span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a>mh5_q <span class="ot">&lt;-</span> <span class="fu">quap</span>(mod_list, <span class="at">data=</span>d)</span>
<span id="cb91-9"><a href="#cb91-9" aria-hidden="true" tabindex="-1"></a>mh5_u <span class="ot">&lt;-</span> <span class="fu">ulam</span>(mod_list, <span class="at">data=</span>d <span class="sc">|&gt;</span> <span class="fu">as.list</span>(), <span class="at">cores=</span><span class="dv">4</span>, <span class="at">chains=</span><span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>mh5_q_samps <span class="ot">&lt;-</span> <span class="fu">extract.samples</span>(mh5_q) <span class="sc">|&gt;</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>mh5_u_samps <span class="ot">&lt;-</span> <span class="fu">extract.samples</span>(mh5_u) <span class="sc">|&gt;</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">2</span>))</span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">colnames</span>(mh5_q_samps)){</span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dens</span>(mh5_q_samps[[i]], <span class="at">main=</span><span class="fu">paste0</span>(<span class="st">'Coef '</span>, i), </span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">col=</span><span class="st">'darkblue'</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dens</span>(mh5_u_samps[[i]], <span class="at">add=</span>T, <span class="at">col=</span><span class="st">'darkred'</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb92-9"><a href="#cb92-9" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ch11_files/figure-html/unnamed-chunk-58-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
<p>It looks like they are actually the same. We are okay to use <code>quap</code> for this problem.</p>
</section>
<section id="b" class="level4">
<h4 class="anchored" data-anchor-id="b">b</h4>
<p>Let’s look at the output from <code>quap</code>:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="fu">precis</span>(mh5_q)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>            mean        sd       5.5%     94.5%
alpha  0.2937859 0.3681383 -0.2945702  0.882142
b_P    1.6209694 0.3063632  1.1313419  2.110597
b_A    0.6517357 0.3054233  0.1636103  1.139861
b_V   -1.6731111 0.3191368 -2.1831534 -1.163069</code></pre>
</div>
</div>
<p>It looks like <span class="math inline">\(P\)</span> and <span class="math inline">\(V\)</span> have about the same effect as each other, but negate each other. <span class="math inline">\(A\)</span> is a positive effect - which makes sense since we would expect the thief being an adult to increase the success rate.</p>
<p>Let’s look at the posterior predictive, we’ll first look at the rate:</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="fu">postcheck</span>(mh5_q)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ch11_files/figure-html/unnamed-chunk-60-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
<p>Instead of the rates, let’s look at the simulated counts:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="fu">sim</span>(mh5_q)</span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>a_pi <span class="ot">&lt;-</span> <span class="fu">apply</span>(a, <span class="dv">2</span>, PI)</span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">colMeans</span>(a), <span class="at">ylim=</span><span class="fu">range</span>(a_pi, d<span class="sc">$</span>y), <span class="at">ylab=</span><span class="st">'Expected Counts'</span>)</span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(d<span class="sc">$</span>y, <span class="at">col=</span>rangi2, <span class="at">pch=</span><span class="dv">16</span>)</span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a><span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">8</span>) <span class="sc">|&gt;</span> <span class="fu">arrows</span>(<span class="at">x0=</span>_, <span class="at">y0=</span>a_pi[<span class="dv">2</span>,], <span class="at">y1=</span>a_pi[<span class="dv">1</span>,], <span class="at">code=</span><span class="dv">0</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ch11_files/figure-html/unnamed-chunk-61-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The proportion plot and the counts plot tell a similar story. In fact, if the pluses overlap with the actual value in the first plot, they are almost guaranteed to in the second. This is becuase they are the same quantities just with different normalizations. What the second plot helps to show is that we get worse predictions as the sample size increases, which is something you wouldn’t immediately see in the first plot.</p>
</section>
<section id="c" class="level4">
<h4 class="anchored" data-anchor-id="c">c</h4>
<p>Let’s add an interaction to the model between the thief’s size and age:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>mod_list <span class="ot">&lt;-</span> <span class="fu">alist</span>(</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>  y <span class="sc">~</span> <span class="fu">dbinom</span>(n, p),</span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">logit</span>(p) <span class="ot">&lt;-</span> alpha <span class="sc">+</span> b_P<span class="sc">*</span>P_ind <span class="sc">+</span> b_A<span class="sc">*</span>A_ind <span class="sc">+</span> b_V<span class="sc">*</span>V_ind <span class="sc">+</span> b_PA<span class="sc">*</span>P_ind<span class="sc">*</span>A_ind,</span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a>  alpha <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="fl">1.5</span>),</span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(b_P, b_A, b_V, b_PA) <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="fl">0.5</span>)</span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-8"><a href="#cb97-8" aria-hidden="true" tabindex="-1"></a>mh5_q2 <span class="ot">&lt;-</span> <span class="fu">quap</span>(mod_list, <span class="at">data=</span>d)</span>
<span id="cb97-9"><a href="#cb97-9" aria-hidden="true" tabindex="-1"></a><span class="fu">precis</span>(mh5_q2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>            mean        sd        5.5%      94.5%
alpha  0.3248665 0.3692523 -0.26527000  0.9150030
b_P    1.5393852 0.3243976  1.02093512  2.0578352
b_A    0.5489449 0.3340236  0.01511058  1.0827792
b_V   -1.6860254 0.3205108 -2.19826357 -1.1737873
b_PA   0.2933371 0.3807133 -0.31511624  0.9017905</code></pre>
</div>
</div>
<p>Let’s see how much it helps:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="fu">compare</span>(mh5_q, mh5_q2, <span class="at">func=</span>PSIS)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Some Pareto k values are very high (&gt;1). Set pointwise=TRUE to inspect individual points.
Some Pareto k values are very high (&gt;1). Set pointwise=TRUE to inspect individual points.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>           PSIS       SE    dPSIS    dSE     pPSIS    weight
mh5_q  60.83718 12.89540 0.000000     NA  8.969411 0.8667644
mh5_q2 64.58248 14.52573 3.745297 2.0066 10.661208 0.1332356</code></pre>
</div>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="fu">compare</span>(mh5_q, mh5_q2, <span class="at">func=</span>WAIC)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>           WAIC       SE    dWAIC      dSE     pWAIC    weight
mh5_q  59.60373 11.88429 0.000000       NA  8.232936 0.8604066
mh5_q2 63.24107 12.59368 3.637342 1.946512 10.118884 0.1395934</code></pre>
</div>
</div>
<p>Looks like the non-interaction model is <em>slightly</em> better, but the difference between the two models is not significant.</p>
</section>
</section>
<section id="h3" class="level3">
<h3 class="anchored" data-anchor-id="h3">H3</h3>
<section id="a-1" class="level4">
<h4 class="anchored" data-anchor-id="a-1">a</h4>
<p>Let’s look at some salamander data:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(salamanders)</span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> salamanders</span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(d)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>'data.frame':   47 obs. of  4 variables:
 $ SITE     : int  1 2 3 4 5 6 7 8 9 10 ...
 $ SALAMAN  : int  13 11 11 9 8 7 6 6 5 5 ...
 $ PCTCOVER : int  85 86 90 88 89 83 83 91 88 90 ...
 $ FORESTAGE: int  316 88 548 64 43 368 200 71 42 551 ...</code></pre>
</div>
</div>
<p>Here SALAMANDER is the number of salamanders in one of the 47 49-sq meter plots. PCTCOVER is the percent ground cover and FORESTAGE is the age of the forest.</p>
<p>Let’s model the relationship between forest cover and salamander density. We’ll check if <code>quap</code> or <code>ulam</code> are much different.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>mod_list <span class="ot">&lt;-</span> <span class="fu">alist</span>(</span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>  SALAMAN <span class="sc">~</span> <span class="fu">dpois</span>(lam),</span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">log</span>(lam) <span class="ot">&lt;-</span> alpha <span class="sc">+</span> b_P<span class="sc">*</span>PCTCOVER,</span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a>  alpha <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="fl">0.5</span>),</span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a>  b_P <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="fl">0.5</span>)</span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb106-7"><a href="#cb106-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-8"><a href="#cb106-8" aria-hidden="true" tabindex="-1"></a>mh3_q <span class="ot">&lt;-</span> <span class="fu">quap</span>(mod_list, <span class="at">data=</span>d)</span>
<span id="cb106-9"><a href="#cb106-9" aria-hidden="true" tabindex="-1"></a>mh3_u <span class="ot">&lt;-</span> <span class="fu">ulam</span>(mod_list, <span class="at">data=</span>d <span class="sc">|&gt;</span> <span class="fu">as.list</span>(), <span class="at">cores=</span><span class="dv">4</span>, <span class="at">chains=</span><span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>mh3_q_samps <span class="ot">&lt;-</span> <span class="fu">extract.samples</span>(mh3_q) <span class="sc">|&gt;</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a>mh3_u_samps <span class="ot">&lt;-</span> <span class="fu">extract.samples</span>(mh3_u) <span class="sc">|&gt;</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">names</span>(mh3_q_samps)){</span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dens</span>(mh3_q_samps[[i]], <span class="at">lwd=</span><span class="dv">2</span>, <span class="at">main=</span><span class="fu">paste0</span>(<span class="st">'Coef: '</span>, i))</span>
<span id="cb107-7"><a href="#cb107-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dens</span>(mh3_u_samps[[i]], <span class="at">lwd=</span><span class="dv">2</span>, <span class="at">col=</span><span class="dv">2</span>, <span class="at">add=</span>T)</span>
<span id="cb107-8"><a href="#cb107-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ch11_files/figure-html/unnamed-chunk-67-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
<p>As we saw with the previous problem, they sit right on top of each other so we are good to use <code>quap</code>.</p>
<p>Let’s look at the expected counts:</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="fu">link</span>(mh3_q)</span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a>a_pi <span class="ot">&lt;-</span> <span class="fu">apply</span>(a, <span class="dv">2</span>, PI)</span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="cn">NULL</span>, <span class="at">xlim=</span><span class="fu">range</span>(d<span class="sc">$</span>PCTCOVER), <span class="at">ylim=</span><span class="fu">range</span>(<span class="dv">0</span>,<span class="dv">6</span>, a_pi), <span class="at">xlab=</span><span class="st">'% Cover'</span>, <span class="at">ylab=</span><span class="st">'Expected Salamanders'</span>)</span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v=</span>d<span class="sc">$</span>PCTCOVER, <span class="at">col=</span><span class="st">'lightgrey'</span>)</span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(d<span class="sc">$</span>PCTCOVER, <span class="fu">colMeans</span>(a), <span class="at">pch=</span><span class="dv">16</span>, <span class="at">col=</span>rangi2, )</span>
<span id="cb108-7"><a href="#cb108-7" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(d<span class="sc">$</span>PCTCOVER, d<span class="sc">$</span>SALAMAN, <span class="at">pch=</span><span class="dv">16</span>)</span>
<span id="cb108-8"><a href="#cb108-8" aria-hidden="true" tabindex="-1"></a><span class="fu">arrows</span>(<span class="at">x0=</span>d<span class="sc">$</span>PCTCOVER, <span class="at">y0=</span>a_pi[<span class="dv">1</span>,], <span class="at">y1=</span>a_pi[<span class="dv">2</span>,], <span class="at">code=</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ch11_files/figure-html/unnamed-chunk-68-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
<p>The model seems to do a good job for low percent cover, but not so well when we get to the upper end.</p>
</section>
<section id="b-1" class="level4">
<h4 class="anchored" data-anchor-id="b-1">b</h4>
<p>Let’s try a model with FORESTAGE:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>d<span class="sc">$</span>FORESTAGE_std <span class="ot">&lt;-</span> (d<span class="sc">$</span>FORESTAGE <span class="sc">-</span> <span class="fu">mean</span>(d<span class="sc">$</span>FORESTAGE)) <span class="sc">/</span> <span class="fu">sd</span>(d<span class="sc">$</span>FORESTAGE)</span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>mod_list <span class="ot">&lt;-</span> <span class="fu">alist</span>(</span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a>  SALAMAN <span class="sc">~</span> <span class="fu">dpois</span>(lam),</span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">log</span>(lam) <span class="ot">&lt;-</span> alpha <span class="sc">+</span> b_P<span class="sc">*</span>PCTCOVER <span class="sc">+</span> b_F<span class="sc">*</span>FORESTAGE_std,</span>
<span id="cb109-6"><a href="#cb109-6" aria-hidden="true" tabindex="-1"></a>  alpha <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="fl">0.5</span>),</span>
<span id="cb109-7"><a href="#cb109-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(b_P, b_F) <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb109-8"><a href="#cb109-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb109-9"><a href="#cb109-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-10"><a href="#cb109-10" aria-hidden="true" tabindex="-1"></a>mh3_q2 <span class="ot">&lt;-</span> <span class="fu">quap</span>(mod_list, <span class="at">data=</span>d)</span>
<span id="cb109-11"><a href="#cb109-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-12"><a href="#cb109-12" aria-hidden="true" tabindex="-1"></a>mod_list <span class="ot">&lt;-</span> <span class="fu">alist</span>(</span>
<span id="cb109-13"><a href="#cb109-13" aria-hidden="true" tabindex="-1"></a>  SALAMAN <span class="sc">~</span> <span class="fu">dpois</span>(lam),</span>
<span id="cb109-14"><a href="#cb109-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">log</span>(lam) <span class="ot">&lt;-</span> alpha <span class="sc">+</span> b_P<span class="sc">*</span>PCTCOVER <span class="sc">+</span> b_F<span class="sc">*</span>FORESTAGE_std <span class="sc">+</span> b_FP<span class="sc">*</span>PCTCOVER<span class="sc">*</span>FORESTAGE_std,</span>
<span id="cb109-15"><a href="#cb109-15" aria-hidden="true" tabindex="-1"></a>  alpha <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="fl">0.5</span>),</span>
<span id="cb109-16"><a href="#cb109-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(b_P, b_F, b_FP) <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="fl">0.5</span>)</span>
<span id="cb109-17"><a href="#cb109-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb109-18"><a href="#cb109-18" aria-hidden="true" tabindex="-1"></a>mh3_q3 <span class="ot">&lt;-</span> <span class="fu">ulam</span>(mod_list, <span class="at">data=</span>d <span class="sc">|&gt;</span> <span class="fu">as.list</span>(), <span class="at">cores=</span><span class="dv">4</span>, <span class="at">chains=</span><span class="dv">4</span>, <span class="at">log_lik=</span>T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="fu">precis</span>(mh3_q2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>             mean          sd        5.5%       94.5%
alpha -0.85365750 0.302846130 -1.33766411 -0.36965089
b_P    0.02487627 0.003870855  0.01868989  0.03106264
b_F    0.03610397 0.094204362 -0.11445279  0.18666074</code></pre>
</div>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="fu">precis</span>(mh3_q3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>             mean        sd        5.5%       94.5%     rhat ess_bulk
alpha -0.44589018 0.5739419 -1.25027825 0.377794000 1.604949 6.925078
b_FP  -0.29881593 0.5102211 -1.18230000 0.001925988 1.625923 6.715455
b_F    0.06118047 0.6772124 -0.95204700 0.964327830 1.552706 7.252268
b_P    0.13829811 0.1992744  0.01659199 0.485689220 1.637206 6.633157</code></pre>
</div>
</div>
<p>From looking at the coefficients, we see that FORESTAGE doesn’t add much as all.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cor</span>(d<span class="sc">$</span>PCTCOVER, d<span class="sc">$</span>FORESTAGE)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.62546</code></pre>
</div>
</div>
<p>It looks like they are pretty highly correlated.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="fu">compare</span>(mh3_q, mh3_q2, mh3_q3, <span class="at">func=</span>PSIS)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in compare(mh3_q, mh3_q2, mh3_q3, func = PSIS): Not all model fits of same class.
This is usually a bad idea, because it implies they were fit by different algorithms.
Check yourself, before you wreck yourself.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Some Pareto k values are very high (&gt;1). Set pointwise=TRUE to inspect individual points.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>               PSIS           SE        dPSIS          dSE        pPSIS
mh3_q  2.147533e+02 2.594918e+01 0.000000e+00           NA 4.426192e+00
mh3_q2 2.178339e+02 2.621609e+01 3.080571e+00 1.624266e+00 6.408210e+00
mh3_q3 8.592590e+52 8.433606e+52 8.592590e+52 8.433606e+52 4.296295e+52
          weight
mh3_q  0.8235062
mh3_q2 0.1764938
mh3_q3 0.0000000</code></pre>
</div>
</div>
<p>Looks like the second and third model does not add much at all. This probably has to do with FORESTAGE containing much of the same information that PCTCOVER has.</p>
</section>
</section>
<section id="h6" class="level3">
<h3 class="anchored" data-anchor-id="h6">H6</h3>
<section id="a-2" class="level4">
<h4 class="anchored" data-anchor-id="a-2">a</h4>
<p>Let’s look at how brain size is associated with social learning:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"Primates301"</span>)</span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> Primates301</span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> d[, <span class="fu">c</span>(<span class="st">'social_learning'</span>, <span class="st">'brain'</span>, <span class="st">'research_effort'</span>)]</span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(d)</span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a>d<span class="sc">$</span>l_brain <span class="ot">&lt;-</span> <span class="fu">log</span>(d<span class="sc">$</span>brain)</span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a>d<span class="sc">$</span>l_research <span class="ot">&lt;-</span> <span class="fu">log</span>(d<span class="sc">$</span>research_effort)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We’ll use a poisson to model <code>social_learning</code> from <code>log(brain size)</code>:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a>mh6_q <span class="ot">&lt;-</span> <span class="fu">quap</span>(<span class="fu">alist</span>(</span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a>  social_learning <span class="sc">~</span> <span class="fu">dpois</span>(lambda),</span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">log</span>(lambda) <span class="ot">&lt;-</span> alpha <span class="sc">+</span> b_b<span class="sc">*</span>l_brain,</span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a>  alpha <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="dv">1</span>),</span>
<span id="cb121-5"><a href="#cb121-5" aria-hidden="true" tabindex="-1"></a>  b_b <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="fl">0.5</span>)</span>
<span id="cb121-6"><a href="#cb121-6" aria-hidden="true" tabindex="-1"></a>), <span class="at">data=</span>d)</span>
<span id="cb121-7"><a href="#cb121-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-8"><a href="#cb121-8" aria-hidden="true" tabindex="-1"></a><span class="fu">precis</span>(mh6_q)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>           mean         sd      5.5%     94.5%
alpha -8.598632 0.30603286 -9.087731 -8.109532
b_b    2.119080 0.05709355  2.027833  2.210327</code></pre>
</div>
</div>
<p>Makes sense - looks like a larger brain is associated with more social learning.</p>
</section>
<section id="b-2" class="level4">
<h4 class="anchored" data-anchor-id="b-2">b</h4>
<p>Now bring research effort into the mix:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a>mh6_q2 <span class="ot">&lt;-</span> <span class="fu">quap</span>(<span class="fu">alist</span>(</span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a>  social_learning <span class="sc">~</span> <span class="fu">dpois</span>(lambda),</span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">log</span>(lambda) <span class="ot">&lt;-</span> alpha <span class="sc">+</span> b_b<span class="sc">*</span>l_brain <span class="sc">+</span> b_r<span class="sc">*</span>l_research,</span>
<span id="cb123-4"><a href="#cb123-4" aria-hidden="true" tabindex="-1"></a>  alpha <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="dv">1</span>),</span>
<span id="cb123-5"><a href="#cb123-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(b_b, b_r) <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="fl">0.5</span>)</span>
<span id="cb123-6"><a href="#cb123-6" aria-hidden="true" tabindex="-1"></a>), <span class="at">data=</span>d)</span>
<span id="cb123-7"><a href="#cb123-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-8"><a href="#cb123-8" aria-hidden="true" tabindex="-1"></a><span class="fu">precis</span>(mh6_q2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>            mean         sd       5.5%      94.5%
alpha -7.1180007 0.27230390 -7.5531949 -6.6828065
b_b    0.2846506 0.06389931  0.1825272  0.3867741
b_r    1.5817757 0.06660479  1.4753284  1.6882230</code></pre>
</div>
</div>
<p>Wow, it looks like in the presence of research effort, the effect of brain size decreases.</p>
</section>
<section id="c-1" class="level4">
<h4 class="anchored" data-anchor-id="c-1">c</h4>
<p>Let’s think about this causally. It makes sense that there might be more research effort, especially in the context of social learning, if the primate species in question has a larger brain size. This is what I expect the DAG to look like:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a>dag_m8<span class="fl">.1</span> <span class="ot">&lt;-</span> <span class="fu">dagitty</span>(<span class="st">"dag{</span></span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a><span class="st">  B -&gt; R -&gt; S</span></span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a><span class="st">  B -&gt; S</span></span>
<span id="cb125-4"><a href="#cb125-4" aria-hidden="true" tabindex="-1"></a><span class="st">}"</span>)</span>
<span id="cb125-5"><a href="#cb125-5" aria-hidden="true" tabindex="-1"></a><span class="fu">coordinates</span>(dag_m8<span class="fl">.1</span>) <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">x=</span><span class="fu">c</span>(<span class="st">'S'</span><span class="ot">=</span><span class="dv">1</span>, <span class="st">'B'</span><span class="ot">=</span><span class="dv">0</span>, <span class="st">'R'</span><span class="ot">=</span><span class="fl">0.5</span>),</span>
<span id="cb125-6"><a href="#cb125-6" aria-hidden="true" tabindex="-1"></a>                              <span class="at">y=</span><span class="fu">c</span>(<span class="st">'S'</span><span class="ot">=</span><span class="dv">0</span>, <span class="st">'B'</span><span class="ot">=</span><span class="dv">0</span>, <span class="st">'R'</span><span class="ot">=</span><span class="sc">-</span><span class="dv">1</span>))</span>
<span id="cb125-7"><a href="#cb125-7" aria-hidden="true" tabindex="-1"></a><span class="fu">drawdag</span>(dag_m8<span class="fl">.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ch11_files/figure-html/unnamed-chunk-77-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>where B is brain size, R is research effort, and S is social learning. Notice that in the DAG their is a direct effect of brain size on social learning, but there is also a mediation pathway where brain size is mediated through research effort.</p>
</section>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>